<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INFIHUILA | Planeador Comercial + Metas</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Export PDF (jsPDF + html2canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Export Excel (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


  <style>
    :root{
      /* === Estilo INFIHUILA === */
      --teal:#0b6f73;
      --teal2:#0a5b5e;
      --teal3:#084a52;

      --lime:#ccd400;
      --olive:#5c6b3f;
      --sand:#efe9df;

      --bg:#f4f7f9;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --border:#e6edf3;

      --shadow: 0 18px 50px rgba(2, 6, 23, .10);
      --shadow2: 0 10px 30px rgba(2, 6, 23, .08);
      --r:18px;
      --r2:26px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at 10% 0%, rgba(204,212,0,.13), transparent 60%),
        radial-gradient(1000px 520px at 90% 0%, rgba(11,111,115,.16), transparent 60%),
        var(--bg);
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 18px 90px;
    }

    /* ===== Header ===== */
    .header{
      border-radius: 34px;
      padding: 18px 22px;
      color:#fff;
      background:
        linear-gradient(135deg, rgba(11,111,115,1) 0%, rgba(10,91,94,1) 55%, rgba(13,99,60,1) 100%);
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .header::after{
      content:"";
      position:absolute;
      inset:-80px -160px auto auto;
      width: 580px; height: 260px;
      transform: rotate(-12deg);
      background: radial-gradient(circle at 30% 40%, rgba(204,212,0,.50), transparent 64%);
      opacity:.55;
      pointer-events:none;
    }

    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      position:relative;
      z-index:1;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 300px;
    }

    
    .logo{
      width: 180px;
      height: 56px;
      border-radius: 14px;
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding: 0;
      border: 0;
      flex:0 0 auto;
    }
    .logo-img{
      width: 180px;
      height: auto;
      max-height: 56px;
      object-fit: contain;
      display:block;
    }


    .logo-mark{
      width: 30px; height: 30px;
      border-radius: 10px;
      position:relative;
      background: rgba(255,255,255,.10);
    }
    .logo-mark::before{
      content:"";
      position:absolute;
      left:2px; top:7px;
      width: 12px; height: 12px;
      border-radius: 999px;
      background: var(--lime);
      transform: rotate(25deg);
      opacity:.95;
    }
    .logo-mark::after{
      content:"";
      position:absolute;
      right:2px; bottom:6px;
      width: 12px; height: 12px;
      border-radius: 6px;
      background: rgba(255,255,255,.92);
      transform: rotate(-15deg);
      opacity:.9;
    }

    .brand-text h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      font-weight:1000;
      line-height:1.15;
    }
    .brand-text p{
      margin: 4px 0 0 0;
      font-size: 13px;
      opacity:.9;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      white-space:nowrap;
      font-weight:900;
      font-size: 13px;
    }
    .chip-btn{ cursor:pointer; }
    .chip-btn:hover{ background: rgba(255,255,255,.18); }
    .dot{
      width: 10px; height: 10px;
      border-radius:999px;
      background: var(--lime);
      box-shadow: 0 0 0 5px rgba(204,212,0,.14);
    }

    /* ===== Tabs row ===== */
    .tabs-row{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      border:0;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight:1000;
      background: rgba(255,255,255,.85);
      color: var(--teal2);
      border: 1px solid rgba(11,111,115,.10);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tab:hover{ filter:brightness(1.02); }
    .tab.active{
      background: #fff;
      border-color: rgba(204,212,0,.55);
      box-shadow: 0 18px 40px rgba(2,6,23,.10);
    }
    .badge{
      font-size: 12px;
      font-weight:1000;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(204,212,0,.18);
      border: 1px solid rgba(204,212,0,.35);
      color: #324000;
    }

    .top-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(11,111,115,.15);
      background: rgba(255,255,255,.88);
      color: var(--teal2);
      font-weight:1000;
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .btn:hover{ background:#fff; }
    .btn.primary{
      border:0;
      color:#fff;
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal2) 70%);
      box-shadow: 0 18px 40px rgba(11,111,115,.20);
    }
    .btn.primary:hover{ filter:brightness(1.05); }

    /* ===== Title strip ===== */
    .title-strip{
      margin-top: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title-strip h2{
      margin:0;
      font-size: 18px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .title-strip p{
      margin:6px 0 0 0;
      color: var(--muted);
      font-size: 13px;
      max-width: 980px;
      line-height: 1.35;
    }

    /* ===== Cards / grids ===== */
    .grid2{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.35fr .95fr;
      gap: 14px;
    }
    @media (max-width: 1100px){
      .grid2{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .chips{ justify-content:flex-start; }
      .top-actions{ justify-content:flex-start; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(11,111,115,.05), transparent);
    }
    .card .hd h3{
      margin:0;
      font-size: 14px;
      font-weight:1000;
      letter-spacing:.2px;
      color: var(--teal3);
    }
    .card .bd{ padding: 14px 16px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
    .kpi{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: linear-gradient(135deg, rgba(11,111,115,.05), rgba(204,212,0,.05));
    }
    .kpi .lbl{ font-size:12px; color:var(--muted); font-weight:900; }
    .kpi .val{ font-size:16px; font-weight:1000; margin-top:4px; }
    .kpi .mini{ font-size:12px; color:var(--muted); margin-top:4px; }

    /* Metas cards (captación/colocación) */
    .meta{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .metaRow{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background:
        linear-gradient(135deg, rgba(95,107,63,.10), rgba(239,233,223,.55));
      position:relative;
      overflow:hidden;
    }
    .metaRow::after{
      content:"";
      position:absolute;
      inset:-30px -60px auto auto;
      width: 200px; height: 120px;
      transform: rotate(-10deg);
      background: radial-gradient(circle at 35% 45%, rgba(204,212,0,.38), transparent 65%);
      opacity:.55;
      pointer-events:none;
    }
    .metaTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .metaTitle{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      color: var(--olive);
      letter-spacing:.2px;
    }
    .metaIcon{
      width:36px; height:36px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background: rgba(11,111,115,.10);
      border:1px solid rgba(11,111,115,.12);
      color: var(--teal3);
      font-weight:1000;
    }
    .metaNums{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
    }
    .metaNum{
      min-width: 160px;
    }
    .metaNum b{
      display:block;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      margin-bottom:4px;
    }
    .metaNum span{
      font-weight:1000;
      color: var(--ink);
    }

    .progress{
      margin-top: 10px;
      height: 12px;
      border-radius: 999px;
      background: rgba(15,23,42,.08);
      overflow:hidden;
      position:relative;
      z-index:1;
    }
    .progress > i{
      display:block;
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--teal), var(--lime));
      box-shadow: 0 10px 24px rgba(11,111,115,.16);
    }
    .progressLabel{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      position:relative;
      z-index:1;
    }

    /* Filters */
    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 160px;
      flex:1;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .field input, .field select, .field textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px 10px;
      outline:none;
      background:#fff;
      font:inherit;
      font-size:13px;
    }
    .field textarea{ min-height:92px; resize:vertical; }

    /* Table */
    .table-wrap{
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--border);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }
    thead th{
      position:sticky; top:0;
      background: #f8fafc;
      font-size:12px;
      text-align:left;
      padding: 10px;
      border-bottom:1px solid var(--border);
      color: #0f172a;
      white-space:nowrap;
    }
    tbody td{
      font-size:12px;
      padding: 10px;
      border-bottom:1px solid #f0f4f8;
      vertical-align:top;
    }
    tbody tr:hover{ background: rgba(11,111,115,.04); }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight:1000;
      font-size: 11px;
      border: 1px solid transparent;
      white-space:nowrap;
    }
    .st-prospecto{ background: rgba(100,116,139,.14); border-color: rgba(100,116,139,.22); color:#334155; }
    .st-gestion{ background: rgba(11,111,115,.14); border-color: rgba(11,111,115,.22); color: var(--teal2); }
    .st-aprobado{ background: rgba(204,212,0,.22); border-color: rgba(204,212,0,.40); color:#3b3b00; }
    .st-desembolsado{ background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.28); color:#14532d; }
    .st-caido{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.22); color:#7f1d1d; }

    .t-actions{ display:flex; gap:8px; }
    .iconbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
    }
    .iconbtn:hover{ background: rgba(2,6,23,.03); }
    .iconbtn.danger{ border-color: rgba(239,68,68,.25); color:#7f1d1d; }
    .iconbtn.danger:hover{ background: rgba(239,68,68,.07); }

    /* Planner */
    .planner-top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
      margin-bottom:10px;
    }
    .slots{
      border:1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      margin-bottom: 12px;
    }
    .slot{
      display:grid;
      grid-template-columns: 90px 1fr;
      gap:10px;
      padding: 10px 12px;
      border-bottom:1px solid #f0f4f8;
      align-items:center;
    }
    .slot:last-child{ border-bottom:0; }
    .time{
      font-weight:1000;
      color: var(--teal3);
      font-size: 12px;
      white-space:nowrap;
    }
    .note{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .note b{ color: var(--ink); }
    .slot-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .mini-btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
    }
    .mini-btn:hover{ background: rgba(2,6,23,.03); }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(2, 6, 23, .55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      width:min(980px, 100%);
      border-radius: 26px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 25px 70px rgba(2,6,23,.35);
    }
    .mhd{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(135deg, rgba(11,111,115,.14), rgba(204,212,0,.10));
      border-bottom:1px solid var(--border);
    }
    .mhd h3{ margin:0; font-size: 14px; font-weight:1000; color: var(--teal3); }
    .mbd{ padding: 14px 16px; }
    .mft{
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .closex{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 6px 12px;
      cursor:pointer;
      font-weight:1000;
    }
    .closex:hover{ background: rgba(2,6,23,.03); }
    /* ===== Botón flotante (Manual) ===== */
    .fab{
      position: fixed;
      right: 18px;
      bottom: 78px; /* sobre el footer */
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: 0;
      cursor: pointer;
      z-index: 60;
      display: grid;
      place-items: center;
      font-weight: 1000;
      font-size: 18px;
      color: #ffffff;
      background: rgba(0,108,115,1);
      box-shadow: 0 18px 45px rgba(2,6,23,.18);
    }
    .fab:hover{ filter: brightness(1.03); transform: translateY(-1px); }
    .fab:active{ transform: translateY(0px) scale(.99); }
    .fab small{
      position:absolute;
      right: 66px;
      bottom: 14px;
      background: rgba(255,255,255,.96);
      border: 1px solid var(--border);
      color: var(--teal3);
      font-size: 12px;
      font-weight: 1000;
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: var(--shadow2);
      opacity: 0;
      pointer-events: none;
      transform: translateX(6px);
      transition: .18s ease;
      white-space: nowrap;
    }
    .fab:hover small{ opacity: 1; transform: translateX(0); }

    /* Manual content */
    .manual h4{
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 1000;
      color: var(--teal3);
      letter-spacing: .2px;
    }
    .manual p, .manual li{
      font-size: 12.5px;
      color: var(--ink);
      line-height: 1.45;
    }
    .manual ul{ margin: 8px 0 14px 18px; }
    .manual .callout{
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(11,111,115,.06), rgba(204,212,0,.06));
      border-radius: 18px;
      padding: 12px;
      margin: 10px 0 14px 0;
    }
    .kbd{
      display:inline-block;
      padding: 1px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 1000;
      font-size: 12px;
      color: var(--teal3);
      vertical-align: baseline;
    }



    /* Footer */
    .footer{
      position:fixed;
      left:0; right:0; bottom:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
      padding: 10px 14px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      z-index:10;
    }

    .muted{ color: var(--muted); font-size: 12px; }
    .nowrap{ white-space:nowrap; }
    .right{ text-align:right; }
  </style>
</head>

<body>
  <!-- BLOQUEO LOGIN (OBLIGATORIO) -->
  <div id="authGate" style="position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;background:rgba(244,247,249,.96);backdrop-filter:blur(10px);">
    <div style="width:min(520px,100%);background:#fff;border:1px solid #e6edf3;border-radius:22px;box-shadow:0 18px 50px rgba(2,6,23,.12);overflow:hidden">
      <div style="padding:16px 18px;background:linear-gradient(135deg,#006C72 0%,#0a5b5e 70%);color:#fff">
        <div style="font-weight:900;font-size:16px">INFIHUILA · Acceso al Planeador</div>
        <div style="opacity:.9;font-size:12px;margin-top:4px">Debes iniciar sesión para continuar.</div>
      </div>

      <div style="padding:16px 18px;display:flex;flex-direction:column;gap:10px">
        <label style="font-size:12px;font-weight:900;color:#64748b">Email</label>
        <input id="loginEmail" type="email" placeholder="usuario@dominio.com"
               style="width:100%;border:1px solid #e6edf3;border-radius:14px;padding:10px 12px;font-size:13px;outline:none">

        <label style="font-size:12px;font-weight:900;color:#64748b;margin-top:6px">Contraseña</label>
        <input id="loginPass" type="password" placeholder="••••••••"
               style="width:100%;border:1px solid #e6edf3;border-radius:14px;padding:10px 12px;font-size:13px;outline:none">

        <button id="btnLogin"
                style="margin-top:8px;border:0;border-radius:14px;padding:11px 12px;font-weight:900;color:#fff;cursor:pointer;background:linear-gradient(135deg,#006C72 0%,#0a5b5e 70%);box-shadow:0 18px 40px rgba(11,111,115,.20)">
          Entrar
        </button>

        <button id="btnReset"
                style="border:1px solid rgba(11,111,115,.18);background:#fff;border-radius:14px;padding:10px 12px;font-weight:900;color:#0a5b5e;cursor:pointer">
          Enviar correo de restablecimiento
        </button>

        <div id="loginMsg" style="font-size:12px;color:#64748b;margin-top:4px"></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HEADER -->
    <header class="header">
      <div class="header-row">
        <div class="brand">
          <div class="logo"><img class="logo-img" src="data:image/png;base64,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" alt="INFIHUILA" /></div>
          <div class="brand-text">
            <h1>INFIHUILA · Planeador comercial + Metas <span id="vigenciaLabel">2026</span></h1>
            <p>Seguimiento de gestión diaria y tablero acumulado vs metas de <b>Captación</b> y <b>Colocación</b>. Líder: <b>Alexander Bautista</b></p>
          </div>
        </div>

        <div class="chips">
          <div class="chip"><span class="dot"></span>Vigencia: <select id="vigenciaSelect" style="margin-left:8px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.12);color:#fff;padding:6px 10px;border-radius:12px;outline:none;font-weight:800"></select></div>
          <div class="chip"><span class="dot"></span>Vigilada por la SFC</div>
          <div class="chip"><span class="dot"></span>Calificación AA+</div>
          <div class="chip"><span class="dot"></span>ISO 9001:2015</div>
	        <button class="btn secondary" id="btnLogout" class="chip chip-btn" type="button" title="Cerrar sesión">Cerrar sesión</button>
        </div>
      </div>





    </header>

    <!-- TABS + ACTIONS -->
    <div class="tabs-row">
      
<div class="tabs" id="navTabs">
        <button class="tab active" type="button" data-view="total">
          Tablero Total <span class="badge" id="badgeTotal">0</span>
        </button>
        <div id="userTabsMount" style="display:contents"></div>
      </div>

      <div class="top-actions">
        <button class="btn primary" id="btnNewProspect" type="button">+ Nuevo prospecto</button>
        <button class="btn" id="btnNewSlot" type="button">+ Nota (hora)</button>
        <button class="btn" id="btnExportPDF" type="button">Exportar PDF</button>
        <button class="btn" id="btnExportExcel" type="button">Exportar Excel</button>
      </div>
    </div>

    <!-- PAGE TITLE -->
    <div class="title-strip">
      <div>
        <h2 id="pageTitle">Tablero Total (Acumulado)</h2>
        <p id="pageSub">Consolidado del equipo comercial. El cumplimiento de metas se calcula con base en registros en estado <b>Desembolsado</b>.</p>
      </div>
      <div class="muted" style="margin-top:4px">
        <b>Fecha:</b> <span id="todayLabel">—</span> · <b>Año:</b> <span id="yearLabel">—</span> ·
        <b>Prospectos hoy:</b> <span id="todayCount">0</span> ·
        <b>Desembolsado hoy:</b> <span id="todayDisb">0</span>
      </div>
    </div>

    <!-- METAS 2026 -->
    <section class="grid2">
      <div class="card">
        <div class="hd">
          <h3>Metas <span class="yr" data-year-label>2026</span> · Colocaciones</h3>
          <div class="muted">Fomento, Tesorería, Cesión, Libranza</div>
        </div>
        <div class="bd">
          <div class="meta" id="metaColoc"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3>Metas <span class="yr" data-year-label>2026</span> · Captación</h3>
          <div class="muted">Depósitos a la Vista y CDAT</div>
        </div>
        <div class="bd">
          <div class="meta" id="metaCapta"></div>
        </div>
      </div>
    </section>

    <!-- KPIS -->
    <section class="card" style="margin-top:14px">
      <div class="hd">
        <h3>Indicadores clave</h3>
        <div class="muted">Barras: valores absolutos · Torta: porcentajes · Tendencia: acumulado mensual</div>
      </div>
      <div class="bd">
        <div class="kpis" id="kpis"></div>
      </div>
    </section>

    <!-- MAIN GRID -->
    <section class="grid">
      <!-- PROSPECTS -->
      <div class="card">
        <div class="hd">
          <h3>Prospectos y gestión</h3>
          <div class="muted">Incluye tipo de meta: Captación / Colocación y sub-línea</div>
        </div>
        <div class="bd">
          <div class="filters">
            <div class="field">
              <label>Fecha (día)</label>
              <input type="date" id="filterDate" />
            </div>
            <div class="field">
              <label>Estado</label>
              <select id="filterStatus">
                <option value="">Todos</option>
                <option>Prospecto</option>
                <option>En gestión</option>
                <option>Aprobado</option>
                <option>Desembolsado</option>
                <option>Caído</option>
              </select>
            </div>
            <div class="field">
              <label>Tipo meta</label>
              <select id="filterType">
                <option value="">Todos</option>
                <option value="Colocación">Colocación</option>
                <option value="Captación">Captación</option>
              </select>
            </div>
            <div class="field">
              <label>Línea / sublínea</label>
              <input id="filterLine" placeholder="Ej: Fomento, CDAT, Libranza..." />
            </div>
            <div class="field">
              <label>Búsqueda</label>
              <input id="filterSearch" placeholder="Nombre / ID / Teléfono..." />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">Fecha</th>
                  <th class="nowrap">Comercial</th>
                  <th>Nombre</th>
                  <th class="nowrap">ID</th>
                  <th class="nowrap">Tipo</th>
                  <th class="nowrap">Sublínea</th>
                  <th class="nowrap right">Valor</th>
                  <th class="nowrap">Estado</th>
                  <th>Observaciones</th>
                  <th class="nowrap">Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyProspects"></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px">
            Importante: para el seguimiento contra metas, el sistema suma únicamente lo que esté en estado <b>Desembolsado</b>.
          </div>
        </div>
      </div>

      <!-- PLANNER + CHARTS -->
      <div class="card">
        <div class="hd">
          <h3>Planeador (hora/día) + Gráficos</h3>
          <div class="muted" id="chartContext">Contexto: equipo total</div>
        </div>
        <div class="bd">
          <div class="planner-top">
            <div class="field" style="min-width:220px; flex:1.2">
              <label>Fecha planeada</label>
              <input type="date" id="plannerDate" />
            </div>
            <div class="field" style="min-width:220px; flex:1">
              <label>Meta mensual individual (opcional)</label>
              <input type="number" id="monthlyGoal" min="0" step="100000" placeholder="Ej: 500000000" />
            </div>
          </div>

          <div class="slots" id="slots"></div>

          <div class="card" style="box-shadow:none;border:0;background:transparent">
            <div class="bd" style="padding:0; display:grid; gap:12px">
              <div class="card">
                <div class="hd">
                  <h3>Barras · Cumplimiento vs metas 2026</h3>
                  <span class="muted">Colocación y Captación</span>
                </div>
                <div class="bd"><canvas id="barMetaChart" height="170"></canvas></div>
              </div>

              <div class="card">
                <div class="hd">
                  <h3>Tendencia mensual</h3>
                  <span class="muted">Desembolsado por mes (acumulado anual)</span>
                </div>
                <div class="bd"><canvas id="trendChart" height="180"></canvas></div>
              </div>

              <div class="card">
                <div class="hd">
                  <h3>Torta · Distribución</h3>
                  <span class="muted">Estados + participación por tipo</span>
                </div>
                <div class="bd"><canvas id="pieChart" height="200"></canvas></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- MODAL: Prospect -->
  <div class="modal-backdrop" id="modalProspect" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mProspectTitle">
      <div class="mhd">
        <h3 id="mProspectTitle">Nuevo prospecto</h3>
        <button class="closex" type="button" data-close="modalProspect">Cerrar ✕</button>
      </div>
      <div class="mbd">
        <div class="filters" style="margin-bottom:0">
          <div class="field" style="min-width: 220px">
            <label>Comercial</label>
            <select id="pUser"></select>
          </div>
          <div class="field">
            <label>Fecha</label>
            <input type="date" id="pDate" />
          </div>
          <div class="field">
            <label>Nombre</label>
            <input id="pName" placeholder="Nombre del prospecto" />
          </div>
          <div class="field">
            <label>ID</label>
            <input id="pId" placeholder="CC / NIT" />
          </div>

          <div class="field" style="min-width: 220px">
            <label>Tipo de meta</label>
            <select id="pType">
              <option value="Colocación">Colocación</option>
              <option value="Captación">Captación</option>
            </select>
          </div>

          <div class="field" style="min-width: 240px">
            <label>Sublínea (según metas 2026)</label>
            <select id="pSubline"></select>
          </div>

          <div class="field">
            <label>Valor (COP)</label>
            <input type="number" id="pValue" min="0" step="100000" placeholder="Ej: 120000000" />
          </div>

          <div class="field">
            <label>Estado</label>
            <select id="pStatus">
              <option>Prospecto</option>
              <option>En gestión</option>
              <option>Aprobado</option>
              <option>Desembolsado</option>
              <option>Caído</option>
            </select>
          </div>

          <div class="field" style="min-width: 360px; flex: 1.6">
            <label>Observaciones</label>
            <textarea id="pNotes" placeholder="Detalle de gestión, próximos pasos, documentos, etc."></textarea>
          </div>
        </div>

        <div class="muted" style="margin-top:10px">
          Nota: Los datos se guardan por <b>usuario</b> en <b>Firestore</b> (y se mantiene una copia local como caché). Usa Exportar JSON para respaldo o traslado.
        </div>
      </div>
      <div class="mft">
        <button class="btn" type="button" id="btnClearForm">Limpiar</button>
        <button class="btn primary" type="button" id="btnSaveProspect">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Slot note -->
  <div class="modal-backdrop" id="modalSlot" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mSlotTitle">
      <div class="mhd">
        <h3 id="mSlotTitle">Nota por hora</h3>
        <button class="closex" type="button" data-close="modalSlot">Cerrar ✕</button>
      </div>
      <div class="mbd">
        <div class="filters" style="margin-bottom:0">
          <div class="field">
            <label>Fecha</label>
            <input type="date" id="sDate" />
          </div>
          <div class="field">
            <label>Hora</label>
            <select id="sHour"></select>
          </div>
          <div class="field">
            <label>Comercial</label>
            <select id="sUser"></select>
          </div>
          <div class="field" style="min-width: 380px; flex:1.8">
            <label>Nota / actividad</label>
            <textarea id="sNote" placeholder="Ej: Llamada con prospecto, visita, radicación de documentos..."></textarea>
          </div>
        </div>
      </div>
      <div class="mft">
        <button class="btn" type="button" id="btnClearSlot">Limpiar</button>
        <button class="btn primary" type="button" id="btnSaveSlot">Guardar nota</button>
      </div>
    </div>
  </div>


  <!-- Botón flotante: Manual -->
  <button class="fab" id="btnManual" type="button" aria-label="Abrir manual de usuario" title="Manual de usuario">
    ?
    <small>Manual de usuario</small>
  </button>

  <!-- MODAL: Manual de usuario -->
  <div class="modal-backdrop" id="modalManual" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mManualTitle">
      <div class="mhd">
        <h3 id="mManualTitle">Manual de usuario · Planeador Comercial INFIHUILA</h3>
        <button class="closex" type="button" data-close="modalManual">Cerrar ✕</button>
      </div>
      <div class="mbd manual">
        <div class="callout">
          <b>Objetivo:</b> registrar y dar seguimiento real a prospectos y actividades del equipo comercial. 
          Toda la información se guarda automáticamente en este navegador.
        </div>

        <h4>1) Navegación</h4>
        <ul>
          <li><b>Tablero Total</b>: consolida resultados de todo el equipo.</li>
          <li><b>Planeador por comercial</b>: selecciona un nombre (Alexander, Luis Eduardo, Carolina, Natalia) para ver su gestión.</li>
        </ul>

        <h4>2) Prospectos</h4>
        <ul>
          <li>Haz clic en <b>+ Nuevo prospecto</b> para registrar una oportunidad.</li>
          <li>Campos clave: <b>Tipo</b> (Colocación/Captación), <b>Sublínea</b>, <b>Valor</b>, <b>Estado</b> y <b>Observaciones</b>.</li>
          <li>En la tabla puedes <b>Editar</b> o <b>Eliminar</b> un registro.</li>
          <li>El cumplimiento de metas se calcula con base en registros en estado <b>Desembolsado</b>.</li>
        </ul>

        <h4>3) Filtros y búsqueda</h4>
        <ul>
          <li>Filtra por fecha, estado, tipo, línea y texto libre para ubicar registros rápidamente.</li>
          <li>Los KPI y gráficas se actualizan automáticamente según el contexto seleccionado.</li>
        </ul>

        <h4>4) Agenda por horas</h4>
        <ul>
          <li>Usa <b>+ Nota (hora)</b> o el botón <b>Agregar</b> en cada franja para registrar actividades (llamadas, visitas, radicación, etc.).</li>
          <li>Puedes registrar múltiples notas por hora y por comercial.</li>
        </ul>

        <h4>5) Exportación</h4>
        <ul>
          <li><b>Exportar PDF</b>: genera un PDF del tablero completo (incluye metas, KPI, tablas y agenda visible).</li>
          <li><b>Exportar Excel</b>: genera un archivo con hojas para <b>Prospectos</b> y <b>Agenda</b>.</li>
        </ul>

        <h4>6) Guardado automático (seguimiento real)</h4>
        <ul>
          <li>Los datos se guardan por <b>usuario</b> en <b>Firestore</b> y se mantiene una copia local como caché (funciona en GitHub Pages).</li>
          <li>Si cambias de equipo o navegador, verás tus datos al iniciar sesión (porque se guardan en Firestore por usuario).</li>
          <li>Recomendación: realiza exportaciones periódicas a Excel como respaldo operativo.</li>
        </ul>

        <div class="callout">
          <b>Atajos:</b> Presiona <span class="kbd">Esc</span> para cerrar cualquier ventana (modal).
        </div>
      </div>
      <div class="mft">
        <button class="btn" type="button" data-close="modalManual">Cerrar</button>
        <button class="btn primary" type="button" onclick="exportPDF()">Exportar PDF</button>
        <button class="btn primary" type="button" onclick="exportExcel()">Exportar Excel</button>
      </div>
    </div>
  </div>


  <div class="footer">
    © <span id="copyrightYear">2026</span> INFIHUILA - Instituto de Financiero para el Huila · Documento controlado. Cualquier impresión es copia no controlada.
  </div>

  <script>
    /***********************
     * 1) Config / helpers
     ***********************/
    // === Vigencia / Config dinámica (NO metas quemadas) ===
const DEFAULT_TEAM = ["Alexander", "Luis Eduardo", "Carolina", "Natalia"];

// Metas institucionales base (2026 según la imagen). Para otras vigencias inicia en 0
const DEFAULT_GOALS = {
  colocacion: {
    total: 34017113417,
    lines: {
      "Fomento": 16778075609,
      "Tesorería": 8389037808,
      "Cesión de derechos": 2850000000,
      "Libranza": 6000000000
    }
  },
  captacion: {
    total: 40000000000,
    lines: {
      "Depósitos a la Vista": 30000000000,
      "Depósitos a término fijo (CDAT)": 10000000000
    }
  }
};

function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

function initialVigencia(){
  const qs = new URLSearchParams(location.search);
  const qy = Number(qs.get("vigencia") || "");
  const ly = Number(localStorage.getItem("infihuila_planeador_vigencia") || "");
  const now = new Date();
  const dy = now.getFullYear();
  const y = (Number.isFinite(qy) && qy>=2020 && qy<=2100) ? qy :
            (Number.isFinite(ly) && ly>=2020 && ly<=2100) ? ly :
            dy;
  return y;
}

let VIGENCIA = initialVigencia();

// Config que se actualizará desde Firestore (admin.html)
let TEAM = deepClone(DEFAULT_TEAM);
let GOALS = (VIGENCIA === 2026) ? deepClone(DEFAULT_GOALS) : {
  colocacion:{ total:0, lines: { "Fomento":0, "Tesorería":0, "Cesión de derechos":0, "Libranza":0 } },
  captacion:{ total:0, lines: { "Depósitos a la Vista":0, "Depósitos a término fijo (CDAT)":0 } }
};

let STORAGE_KEY = "";
let STORAGE_GOALS_KEY = "";
let STORAGE_SLOTS_KEY = "";

function setStorageKeys(year){
  STORAGE_KEY = `infihuila_planeador_comercial_${year}_v1`;
  STORAGE_GOALS_KEY = `infihuila_planeador_metas_individuales_${year}_v1`;
  STORAGE_SLOTS_KEY = `infihuila_planeador_slots_${year}_v1`;
}
setStorageKeys(VIGENCIA);

    const fmtCOP = new Intl.NumberFormat("es-CO", { style:"currency", currency:"COP", maximumFractionDigits:0 });

    function uid(){ return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
    function todayISO(){
      const d = new Date();
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    }
    function clampStr(s, max=180){
      s = (s ?? "").toString();
      return s.length > max ? s.slice(0, max-1) + "…" : s;
    }
    function safeGetJSON(key, fallback){
      try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
      catch(e){ return fallback; }
    }
    function safeSetJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

    function statusClass(status){
      switch(status){
        case "Prospecto": return "st-prospecto";
        case "En gestión": return "st-gestion";
        case "Aprobado": return "st-aprobado";
        case "Desembolsado": return "st-desembolsado";
        case "Caído": return "st-caido";
        default: return "st-prospecto";
      }
    }

    /***********************
     * 2) App state
     ***********************/
    const state = {
      view: { type: "total", user: null }, // total | comercial
      prospects: safeGetJSON(STORAGE_KEY, []),
      goalsInd: safeGetJSON(STORAGE_GOALS_KEY, {}), // { user: { "YYYY-MM": value } }
      slots: safeGetJSON(STORAGE_SLOTS_KEY, {}), // { "YYYY-MM-DD": { "09:00":[{user,note,ts}] } }
      filters: { date:"", status:"", type:"", line:"", search:"" },
      editingProspectId: null
    };

    /***********************
     * 3) DOM refs
     ***********************/
    const el = {
      navTabs: document.getElementById("navTabs"),
      pageTitle: document.getElementById("pageTitle"),
      pageSub: document.getElementById("pageSub"),
      chartContext: document.getElementById("chartContext"),
      kpis: document.getElementById("kpis"),
      tbody: document.getElementById("tbodyProspects"),

      filterDate: document.getElementById("filterDate"),
      filterStatus: document.getElementById("filterStatus"),
      filterType: document.getElementById("filterType"),
      filterLine: document.getElementById("filterLine"),
      filterSearch: document.getElementById("filterSearch"),

      plannerDate: document.getElementById("plannerDate"),
      monthlyGoal: document.getElementById("monthlyGoal"),
      slots: document.getElementById("slots"),

      metaColoc: document.getElementById("metaColoc"),
      metaCapta: document.getElementById("metaCapta"),

      btnNewProspect: document.getElementById("btnNewProspect"),
      btnNewSlot: document.getElementById("btnNewSlot"),
      btnExportPDF: document.getElementById("btnExportPDF"),
      btnExportExcel: document.getElementById("btnExportExcel"),

      btnManual: document.getElementById("btnManual"),

      modalManual: document.getElementById("modalManual"),

      todayLabel: document.getElementById("todayLabel"),
      yearLabel: document.getElementById("yearLabel"),
      todayCount: document.getElementById("todayCount"),
      todayDisb: document.getElementById("todayDisb"),

      modalProspect: document.getElementById("modalProspect"),
      modalSlot: document.getElementById("modalSlot"),

      // Prospect form
      pUser: document.getElementById("pUser"),
      pDate: document.getElementById("pDate"),
      pName: document.getElementById("pName"),
      pId: document.getElementById("pId"),
      pType: document.getElementById("pType"),
      pSubline: document.getElementById("pSubline"),
      pValue: document.getElementById("pValue"),
      pStatus: document.getElementById("pStatus"),
      pNotes: document.getElementById("pNotes"),
      btnSaveProspect: document.getElementById("btnSaveProspect"),
      btnClearForm: document.getElementById("btnClearForm"),

      // Slot form
      sDate: document.getElementById("sDate"),
      sHour: document.getElementById("sHour"),
      sUser: document.getElementById("sUser"),
      sNote: document.getElementById("sNote"),
      btnSaveSlot: document.getElementById("btnSaveSlot"),
      btnClearSlot: document.getElementById("btnClearSlot"),
    };

    /***********************
     * 4) Charts
     ***********************/
    let barMetaChart, trendChart, pieChart;

    function initCharts(){
      barMetaChart = new Chart(document.getElementById("barMetaChart"), {
        type: "bar",
        data: {
          labels: ["Colocación", "Captación"],
          datasets: [
            { label:"Acumulado (Desembolsado)", data:[0,0] },
            { label:`Meta ${VIGENCIA}`, data:[GOALS.colocacion.total, GOALS.captacion.total] }
          ]
        },
        options: {
          responsive:true,
          plugins:{
            legend:{ position:"bottom" },
            tooltip:{
              callbacks:{
                label:(ctx)=> `${ctx.dataset.label}: ${fmtCOP.format(ctx.parsed.y||0)}`
              }
            }
          },
          scales:{
            y:{
              beginAtZero:true,
              ticks:{ callback:(v)=> fmtCOP.format(v).replace("$","$ ") }
            }
          }
        }
      });

      trendChart = new Chart(document.getElementById("trendChart"), {
        type:"line",
        data:{
          labels:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],
          datasets:[
            { label:"Colocación (Desembolsado)", data:Array(12).fill(0), tension:0.25 },
            { label:"Captación (Desembolsado)", data:Array(12).fill(0), tension:0.25 }
          ]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{ position:"bottom" },
            tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtCOP.format(ctx.parsed.y||0)}` } }
          },
          scales:{
            y:{ beginAtZero:true, ticks:{ callback:(v)=> fmtCOP.format(v).replace("$","$ ") } }
          }
        }
      });

      pieChart = new Chart(document.getElementById("pieChart"), {
        type:"pie",
        data:{
          labels:["Prospecto","En gestión","Aprobado","Desembolsado","Caído","Colocación (Des.)","Captación (Des.)"],
          datasets:[{ data:[0,0,0,0,0,0,0] }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{ position:"bottom" },
            tooltip:{
              callbacks:{
                label:(ctx)=>{
                  const total = sum(ctx.dataset.data);
                  const val = ctx.parsed || 0;
                  const pct = total ? (val/total*100) : 0;
                  return `${ctx.label}: ${val.toLocaleString("es-CO")} (${pct.toFixed(1)}%)`;
                }
              }
            }
          }
        }
      });
    }

    /***********************
     * 5) Derivations
     ***********************/
    function viewRows(){
      let rows = [...state.prospects];

      if(state.view.type==="comercial" && state.view.user){
        rows = rows.filter(r => r.user === state.view.user);
      }

      const f = state.filters;
      if(f.date) rows = rows.filter(r => r.date === f.date);
      if(f.status) rows = rows.filter(r => r.status === f.status);
      if(f.type) rows = rows.filter(r => (r.type||"") === f.type);

      if(f.line){
        const s = f.line.trim().toLowerCase();
        if(s) rows = rows.filter(r => (r.subline||"").toLowerCase().includes(s));
      }
      if(f.search){
        const s = f.search.trim().toLowerCase();
        if(s){
          rows = rows.filter(r=>{
            const hay = [r.name,r.id,r.user,r.type,r.subline,r.notes].join(" ").toLowerCase();
            return hay.includes(s);
          });
        }
      }

      rows.sort((a,b)=>{
        const da=(a.date||""), db=(b.date||"");
        if(da!==db) return db.localeCompare(da);
        return (b.ts||0)-(a.ts||0);
      });

      return rows;
    }

    function monthKey(dateISO){ return dateISO ? dateISO.slice(0,7) : ""; }
    function getIndGoal(user, dateISO){
      const mk = monthKey(dateISO);
      return Number(state.goalsInd?.[user]?.[mk] ?? 0);
    }
    function setIndGoal(user, dateISO, value){
      const mk = monthKey(dateISO);
      if(!state.goalsInd[user]) state.goalsInd[user] = {};
      state.goalsInd[user][mk] = Number(value||0);
      safeSetJSON(STORAGE_GOALS_KEY, state.goalsInd);
    }

    function calcAccumulatedDesembolsado(rows){
      // Acumulado 2026 por tipo/sublinea (solo estado Desembolsado)
      const coloc = { total:0, byLine:{} };
      const capta = { total:0, byLine:{} };

      Object.keys(GOALS.colocacion.lines).forEach(k=> coloc.byLine[k]=0);
      Object.keys(GOALS.captacion.lines).forEach(k=> capta.byLine[k]=0);

      rows
        .filter(r=>r.status==="Desembolsado")
        .forEach(r=>{
          const val = Number(r.value||0);
          if((r.type||"")==="Colocación"){
            coloc.total += val;
            if(coloc.byLine[r.subline] !== undefined) coloc.byLine[r.subline] += val;
          }else if((r.type||"")==="Captación"){
            capta.total += val;
            if(capta.byLine[r.subline] !== undefined) capta.byLine[r.subline] += val;
          }
        });

      return { coloc, capta };
    }

    function monthlyTrend(rows){
      // Suma por mes (enero=0) para colocación/captación; solo Desembolsado
      const coloc = Array(12).fill(0);
      const capta = Array(12).fill(0);

      rows.filter(r=>r.status==="Desembolsado").forEach(r=>{
        const d = r.date;
        if(!d) return;
        const m = Number(d.slice(5,7)) - 1;
        if(m<0 || m>11) return;
        const val = Number(r.value||0);
        if(r.type==="Colocación") coloc[m]+=val;
        if(r.type==="Captación") capta[m]+=val;
      });

      // acumulado (tendencia)
      for(let i=1;i<12;i++){
        coloc[i]+=coloc[i-1];
        capta[i]+=capta[i-1];
      }
      return { coloc, capta };
    }

    /***********************
     * 6) Render
     ***********************/
    function rowHTML(r){
      const pill = `<span class="pill ${statusClass(r.status)}">${r.status}</span>`;
      return `
        <tr data-id="${r._id}">
          <td class="nowrap">${r.date || ""}</td>
          <td class="nowrap"><b>${r.user || ""}</b></td>
          <td>${clampStr(r.name, 60)}</td>
          <td class="nowrap">${clampStr(r.id, 30)}</td>
          <td class="nowrap"><b>${r.type || ""}</b></td>
          <td class="nowrap">${clampStr(r.subline, 42)}</td>
          <td class="right nowrap"><b>${fmtCOP.format(Number(r.value||0))}</b></td>
          <td class="nowrap">${pill}</td>
          <td>${clampStr(r.notes, 90)}</td>
          <td class="nowrap">
            <div class="t-actions">
              <button class="iconbtn" type="button" data-action="edit">Editar</button>
              <button class="iconbtn danger" type="button" data-action="delete">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }

    function renderMetasCards(rowsAllContext){
      // metas siempre se calculan con el contexto actual (total o comercial)
      const acc = calcAccumulatedDesembolsado(rowsAllContext);

      // Colocación
      const colocLines = Object.entries(GOALS.colocacion.lines).map(([k,meta])=>{
        const actual = acc.coloc.byLine[k] || 0;
        const pct = meta>0 ? Math.min(100, actual/meta*100) : 0;
        return { name:k, meta, actual, pct };
      });

      const colocTotalPct = GOALS.colocacion.total>0 ? Math.min(100, acc.coloc.total/GOALS.colocacion.total*100) : 0;

      el.metaColoc.innerHTML = `
        ${metaRowHTML("Total Colocaciones", "↗", acc.coloc.total, GOALS.colocacion.total, colocTotalPct)}
        ${colocLines.map(x=> metaRowHTML(x.name, "💼", x.actual, x.meta, x.pct)).join("")}
      `;

      // Captación
      const captaLines = Object.entries(GOALS.captacion.lines).map(([k,meta])=>{
        const actual = acc.capta.byLine[k] || 0;
        const pct = meta>0 ? Math.min(100, actual/meta*100) : 0;
        return { name:k, meta, actual, pct };
      });

      const captaTotalPct = GOALS.captacion.total>0 ? Math.min(100, acc.capta.total/GOALS.captacion.total*100) : 0;

      el.metaCapta.innerHTML = `
        ${metaRowHTML("Total Captación", "🏦", acc.capta.total, GOALS.captacion.total, captaTotalPct)}
        ${captaLines.map(x=> metaRowHTML(x.name, "💰", x.actual, x.meta, x.pct)).join("")}
      `;
    }

    function metaRowHTML(title, icon, actual, meta, pct){
      return `
        <div class="metaRow">
          <div class="metaTop">
            <div class="metaTitle">
              <div class="metaIcon">${icon}</div>
              ${title}
            </div>
            <div class="metaNums">
              <div class="metaNum">
                <b>Acumulado</b>
                <span>${fmtCOP.format(actual)}</span>
              </div>
              <div class="metaNum">
                <b>${VIGENCIA}</b>
                <span>${fmtCOP.format(meta)}</span>
              </div>
            </div>
          </div>
          <div class="progress" aria-label="progreso">
            <i style="width:${pct.toFixed(2)}%"></i>
          </div>
          <div class="progressLabel">
            <span>Cumplimiento: <b>${pct.toFixed(1)}%</b></span>
            <span>Brecha: <b>${fmtCOP.format(Math.max(0, meta-actual))}</b></span>
          </div>
        </div>
      `;
    }

    function renderKPIs(rowsContext){
      // KPIs de contexto (según filtros) + vs metas (contexto sin filtros para metas)
      const totalRegs = rowsContext.length;
      const totalVal = sum(rowsContext.map(r=>Number(r.value||0)));
      const desembVal = sum(rowsContext.filter(r=>r.status==="Desembolsado").map(r=>Number(r.value||0)));

      const desembColoc = sum(rowsContext.filter(r=>r.status==="Desembolsado" && r.type==="Colocación").map(r=>Number(r.value||0)));
      const desembCapta = sum(rowsContext.filter(r=>r.status==="Desembolsado" && r.type==="Captación").map(r=>Number(r.value||0)));

      const pctColoc = GOALS.colocacion.total ? (desembColoc/GOALS.colocacion.total*100) : 0;
      const pctCapta = GOALS.captacion.total ? (desembCapta/GOALS.captacion.total*100) : 0;

      const items = [
        { lbl:"# Registros (tabla)", val: totalRegs.toLocaleString("es-CO"), mini:"Según filtros actuales" },
        { lbl:"Valor total (tabla)", val: fmtCOP.format(totalVal), mini:"Prospectado (según filtros)" },
        { lbl:"Desembolsado (tabla)", val: fmtCOP.format(desembVal), mini:"Base para cumplimiento de metas" },
        { lbl:"Cumplimiento metas (des.)", val: `${((pctColoc+pctCapta)/2).toFixed(1)}%`, mini:`Coloc: ${pctColoc.toFixed(1)}% · Capt: ${pctCapta.toFixed(1)}%` }
      ];

      el.kpis.innerHTML = items.map(x=>`
        <div class="kpi">
          <div class="lbl">${x.lbl}</div>
          <div class="val">${x.val}</div>
          <div class="mini">${x.mini}</div>
        </div>
      `).join("");
    }

    function buildHours(){
      const out = [];
      for(let h=8; h<=18; h++) out.push(String(h).padStart(2,"0")+":00");
      return out;
    }

    function renderSlots(){
      const d = el.plannerDate.value || todayISO();
      const daySlots = state.slots[d] || {};
      const hours = buildHours();

      el.slots.innerHTML = hours.map(h=>{
        const notes = (daySlots[h] || []);
        const htmlNotes = notes.length
          ? notes.map(n=> `<div class="note"><b>${n.user}</b>: ${clampStr(n.note, 120)}</div>`).join("")
          : `<div class="note muted">Sin actividades registradas.</div>`;

        return `
          <div class="slot" data-hour="${h}">
            <div class="time">${h}</div>
            <div>
              ${htmlNotes}
              <div class="slot-actions">
                <button class="mini-btn" type="button" data-slot-action="add" data-hour="${h}">+ Agregar</button>
                <button class="mini-btn" type="button" data-slot-action="clear" data-hour="${h}">Limpiar</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // Meta mensual individual (solo en vista comercial)
      const dateISO = el.plannerDate.value || todayISO();
      if(state.view.type==="comercial" && state.view.user){
        const g = getIndGoal(state.view.user, dateISO);
        el.monthlyGoal.value = g ? String(g) : "";
        el.monthlyGoal.disabled = false;
      }else{
        el.monthlyGoal.value = "";
        el.monthlyGoal.disabled = true;
      }
    }

    function slugId(name){
  return (name||"")
    .toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-zA-Z0-9]+/g,"")
    .trim();
}

function renderTabs(){
  const mount = document.getElementById("userTabsMount");
  if(!mount) return;
  mount.innerHTML = TEAM.map(u=>{
    const id = slugId(u) || "X";
    return `<button class="tab" type="button" data-view="comercial" data-user="${u}">
              ${u} <span class="badge" id="badge_${id}">0</span>
            </button>`;
  }).join("");
  // Ajusta el estado activo sin romper navegación
  [...el.navTabs.querySelectorAll(".tab")].forEach(b=>{
    const isTotal = b.dataset.view==="total" && state.view.type==="total";
    const isUser  = b.dataset.view==="comercial" && state.view.type==="comercial" && b.dataset.user===state.view.user;
    b.classList.toggle("active", isTotal || isUser);
  });
}

function updateBadges(){
  const all = [...state.prospects];
  const bt = document.getElementById("badgeTotal");
  if(bt) bt.textContent = all.length;

  TEAM.forEach(u=>{
    const id = slugId(u) || "X";
    const badge = document.getElementById(`badge_${id}`);
    if(!badge) return;
    const n = all.filter(p=>p.user===u).length;
    badge.textContent = n;
  });
}

    function renderQuick(){
      const t = new Date();
      el.todayLabel.textContent = t.toLocaleDateString("es-CO", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
      el.yearLabel.textContent = String(t.getFullYear());

      const td = todayISO();
      const todayRows = state.prospects.filter(p=>p.date===td);
      el.todayCount.textContent = todayRows.length.toLocaleString("es-CO");

      const disb = sum(todayRows.filter(p=>p.status==="Desembolsado").map(p=>Number(p.value||0)));
      el.todayDisb.textContent = fmtCOP.format(disb);
    }

    function updateCharts(rowsContext){
      // Para metas/linea/tendencia: usar filas del contexto SIN filtros? -> usamos "rowsAllContext" aparte en render()
      // Aquí usamos rowsContext para torta por estados y para tipo (desembolsado).
      const counts = {
        "Prospecto": rowsContext.filter(r=>r.status==="Prospecto").length,
        "En gestión": rowsContext.filter(r=>r.status==="En gestión").length,
        "Aprobado": rowsContext.filter(r=>r.status==="Aprobado").length,
        "Desembolsado": rowsContext.filter(r=>r.status==="Desembolsado").length,
        "Caído": rowsContext.filter(r=>r.status==="Caído").length
      };
      const colocDes = rowsContext.filter(r=>r.status==="Desembolsado" && r.type==="Colocación").length;
      const captaDes = rowsContext.filter(r=>r.status==="Desembolsado" && r.type==="Captación").length;

      pieChart.data.datasets[0].data = [
        counts["Prospecto"],
        counts["En gestión"],
        counts["Aprobado"],
        counts["Desembolsado"],
        counts["Caído"],
        colocDes,
        captaDes
      ];
      pieChart.update();
    }

    function updateMetaCharts(rowsAllContext){
      // Barras vs meta (acumulado desembolsado por tipo)
      const acc = calcAccumulatedDesembolsado(rowsAllContext);

      barMetaChart.data.datasets[0].data = [acc.coloc.total, acc.capta.total];
      barMetaChart.data.datasets[1].data = [GOALS.colocacion.total, GOALS.captacion.total];
      barMetaChart.update();

      // Tendencia mensual acumulada
      const tr = monthlyTrend(rowsAllContext);
      trendChart.data.datasets[0].data = tr.coloc;
      trendChart.data.datasets[1].data = tr.capta;
      trendChart.update();
    }

    /***********************
     * 7) Modals
     ***********************/
    function openModal(id){
      const m = document.getElementById(id);
      if(!m) return;
      m.classList.add("open");
      m.setAttribute("aria-hidden","false");
    }
    function closeModal(id){
      const m = document.getElementById(id);
      if(!m) return;
      m.classList.remove("open");
      m.setAttribute("aria-hidden","true");
    }
    function attachBackdropClose(backdropId){
      const bd = document.getElementById(backdropId);
      bd.addEventListener("mousedown", (e)=>{
        if(e.target === bd) closeModal(backdropId);
      });
    }

    /***********************
     * 8) CRUD Prospect
     ***********************/
    function resetProspectForm(){
      state.editingProspectId = null;
      document.getElementById("mProspectTitle").textContent = "Nuevo prospecto";

      el.pUser.value = state.view.type==="comercial" ? (state.view.user || TEAM[0]) : TEAM[0];
      el.pDate.value = todayISO();
      el.pName.value = "";
      el.pId.value = "";
      el.pType.value = "Colocación";
      refreshSublineOptions();
      el.pValue.value = "";
      el.pStatus.value = "Prospecto";
      el.pNotes.value = "";
    }

    function fillProspectForm(p){
      state.editingProspectId = p._id;
      document.getElementById("mProspectTitle").textContent = "Editar prospecto";

      el.pUser.value = p.user || TEAM[0];
      el.pDate.value = p.date || todayISO();
      el.pName.value = p.name || "";
      el.pId.value = p.id || "";
      el.pType.value = p.type || "Colocación";
      refreshSublineOptions();
      el.pSubline.value = p.subline || el.pSubline.value;
      el.pValue.value = String(Number(p.value||0));
      el.pStatus.value = p.status || "Prospecto";
      el.pNotes.value = p.notes || "";
    }

    function upsertProspectFromForm(){
      const p = {
        _id: state.editingProspectId || uid(),
        ts: Date.now(),
        user: el.pUser.value,
        date: el.pDate.value || todayISO(),
        name: el.pName.value.trim(),
        id: el.pId.value.trim(),
        type: el.pType.value,
        subline: el.pSubline.value,
        value: Number(el.pValue.value || 0),
        status: el.pStatus.value,
        notes: el.pNotes.value.trim()
      };

      if(!p.name){ alert("Por favor ingresa el nombre del prospecto."); el.pName.focus(); return false; }
      if(!p.user){ alert("Selecciona un comercial."); return false; }
      if(!p.subline){ alert("Selecciona una sublínea."); return false; }

      const idx = state.prospects.findIndex(x => x._id === p._id);
      if(idx >= 0) state.prospects[idx] = { ...state.prospects[idx], ...p };
      else state.prospects.push(p);

      safeSetJSON(STORAGE_KEY, state.prospects);
      return true;
    }

    function deleteProspect(id){
      const p = state.prospects.find(x=>x._id===id);
      if(!p) return;
      const ok = confirm(`¿Eliminar el prospecto "${p.name}" (${p.user})?`);
      if(!ok) return;
      state.prospects = state.prospects.filter(x=>x._id!==id);
      safeSetJSON(STORAGE_KEY, state.prospects);
      render();
    }

    /***********************
     * 9) Slots CRUD
     ***********************/
    function resetSlotForm(hour){
      el.sDate.value = el.plannerDate.value || todayISO();
      el.sHour.value = hour || buildHours()[0];
      el.sUser.value = state.view.type==="comercial" ? (state.view.user || TEAM[0]) : TEAM[0];
      el.sNote.value = "";
    }

    function saveSlotFromForm(){
      const d = el.sDate.value || todayISO();
      const h = el.sHour.value;
      const u = el.sUser.value;
      const note = el.sNote.value.trim();

      if(!note){ alert("Escribe una nota/actividad."); el.sNote.focus(); return false; }

      if(!state.slots[d]) state.slots[d] = {};
      if(!state.slots[d][h]) state.slots[d][h] = [];
      state.slots[d][h].push({ user:u, note, ts: Date.now() });

      safeSetJSON(STORAGE_SLOTS_KEY, state.slots);
      return true;
    }

    function clearSlot(day, hour){
      const ok = confirm(`¿Limpiar actividades de ${day} a las ${hour}?`);
      if(!ok) return;
      if(state.slots?.[day]?.[hour]){
        state.slots[day][hour] = [];
        safeSetJSON(STORAGE_SLOTS_KEY, state.slots);
        renderSlots();
      }
    }

    /***********************
     * 10) Import/Export
     ***********************/
    function exportJSON(){
      const payload = {
        exportedAt: new Date().toISOString(),
        goals2026: GOALS,
        prospects: state.prospects,
        goalsInd: state.goalsInd,
        slots: state.slots
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `planeador_infihuila_metas_${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== Export PDF (tablero completo) =====
    async function exportPDF(){
      try{
        const target = document.querySelector(".wrap");
        if(!target){ alert("No se encontró el contenido a exportar."); return; }

        const canvas = await html2canvas(target, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        const imgW = pageW;
        const imgH = (canvas.height * imgW) / canvas.width;

        // Si el contenido excede una página, lo partimos en páginas
        let y = 0;
        let remaining = imgH;

        // Dibujamos la imagen como una "tira" y paginamos
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, y, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0){
            pdf.addPage();
            y -= pageH;
          }
        }

        const stamp = new Date().toISOString().slice(0,10);
        pdf.save(`INFIHUILA_Tablero_Comercial_${stamp}.pdf`);
      }catch(err){
        console.error(err);
        alert("No se pudo exportar a PDF. Revisa la consola (F12).");
      }
    }

    // ===== Export Excel (prospectos + agenda) =====
    function exportExcel(){
      try{
        if(typeof XLSX === "undefined"){
          alert("No se cargó la librería de Excel (XLSX). Verifica tu conexión.");
          return;
        }

        const wb = XLSX.utils.book_new();

        // Prospectos
        const prospects = safeGetJSON("prospects", []);
        const ws1 = XLSX.utils.json_to_sheet(prospects.map(p => ({
          Fecha: p.date || "",
          Hora: p.time || "",
          Comercial: p.agent || "",
          Nombre: p.name || "",
          Identificación: p.id || "",
          Tipo: p.type || "",
          Sublínea: p.subline || "",
          Valor: p.amount || 0,
          Estado: p.status || "",
          Observaciones: p.notes || ""
        })));
        XLSX.utils.book_append_sheet(wb, ws1, "Prospectos");

        // Agenda (slots)
        const slots = safeGetJSON("slots", []);
        const ws2 = XLSX.utils.json_to_sheet(slots.map(s => ({
          Hora: s.time || "",
          Actividad: s.title || "",
          Comercial: s.agent || "",
          Estado: s.state || "",
          Detalle: s.detail || ""
        })));
        XLSX.utils.book_append_sheet(wb, ws2, "Agenda");

        const stamp = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `INFIHUILA_Seguimiento_${stamp}.xlsx`);
      }catch(err){
        console.error(err);
        alert("No se pudo exportar a Excel. Revisa la consola (F12).");
      }
    }


    function importJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          if(!obj || typeof obj !== "object") throw new Error("JSON inválido");

          if(Array.isArray(obj.prospects)) state.prospects = obj.prospects;
          if(obj.goalsInd && typeof obj.goalsInd === "object") state.goalsInd = obj.goalsInd;
          if(obj.slots && typeof obj.slots === "object") state.slots = obj.slots;

          safeSetJSON(STORAGE_KEY, state.prospects);
          safeSetJSON(STORAGE_GOALS_KEY, state.goalsInd);
          safeSetJSON(STORAGE_SLOTS_KEY, state.slots);

          alert("Importación exitosa.");
          render();
        }catch(e){
          alert("No se pudo importar. Verifica que sea un JSON válido del planeador.");
        }
      };
      reader.readAsText(file);
    }

    /***********************
     * 11) Subline options
     ***********************/
    function refreshSublineOptions(){
      const type = el.pType.value;
      const opts = type==="Captación"
        ? Object.keys(GOALS.captacion.lines)
        : Object.keys(GOALS.colocacion.lines);

      el.pSubline.innerHTML = opts.map(o=>`<option value="${o}">${o}</option>`).join("");
    }

    /***********************
     * 12) Events
     ***********************/
    function syncFiltersToUI(){
      el.filterDate.value = state.filters.date || "";
      el.filterStatus.value = state.filters.status || "";
      el.filterType.value = state.filters.type || "";
      el.filterLine.value = state.filters.line || "";
      el.filterSearch.value = state.filters.search || "";
    }

    function bindEvents(){

      // Manual (botón flotante)
      if(el.btnManual){
        el.btnManual.addEventListener("click", ()=> openModal("modalManual"));
      }
      // Tabs navigation
      el.navTabs.addEventListener("click", (e)=>{
        const btn = e.target.closest("button.tab");
        if(!btn) return;

        const view = btn.dataset.view;
        if(view==="total") state.view = { type:"total", user:null };
        else state.view = { type:"comercial", user: btn.dataset.user || TEAM[0] };

        state.filters = { date:"", status:"", type:"", line:"", search:"" };
        syncFiltersToUI();
        render();
      });

      // Filters
      el.filterDate.addEventListener("input", ()=>{ state.filters.date = el.filterDate.value; render(); });
      el.filterStatus.addEventListener("change", ()=>{ state.filters.status = el.filterStatus.value; render(); });
      el.filterType.addEventListener("change", ()=>{ state.filters.type = el.filterType.value; render(); });
      el.filterLine.addEventListener("input", ()=>{ state.filters.line = el.filterLine.value; render(); });
      el.filterSearch.addEventListener("input", ()=>{ state.filters.search = el.filterSearch.value; render(); });

      // Planner
      el.plannerDate.addEventListener("change", ()=> render());

      el.monthlyGoal.addEventListener("change", ()=>{
        const d = el.plannerDate.value || todayISO();
        if(state.view.type==="comercial" && state.view.user){
          setIndGoal(state.view.user, d, el.monthlyGoal.value);
          render();
        }
      });

      // Prospect type change -> sublines update
      el.pType.addEventListener("change", refreshSublineOptions);

      // Top actions
      el.btnNewProspect.addEventListener("click", ()=>{
        resetProspectForm();
        el.pDate.value = el.plannerDate.value || todayISO();
        openModal("modalProspect");
      });

      el.btnNewSlot.addEventListener("click", ()=>{
        resetSlotForm();
        openModal("modalSlot");
      });

      // Export PDF/Excel
      if(el.btnExportPDF) el.btnExportPDF.addEventListener("click", exportPDF);
      if(el.btnExportExcel) el.btnExportExcel.addEventListener("click", exportExcel);
// Prospect modal
      el.btnClearForm.addEventListener("click", resetProspectForm);
      el.btnSaveProspect.addEventListener("click", ()=>{
        const ok = upsertProspectFromForm();
        if(ok){
          closeModal("modalProspect");
          render();
        }
      });

      // Slot modal
      el.btnClearSlot.addEventListener("click", ()=> resetSlotForm(el.sHour.value));
      el.btnSaveSlot.addEventListener("click", ()=>{
        const ok = saveSlotFromForm();
        if(ok){
          closeModal("modalSlot");
          renderSlots();
        }
      });

      // Table actions
      el.tbody.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-action]");
        if(!btn) return;
        const tr = e.target.closest("tr[data-id]");
        if(!tr) return;
        const id = tr.dataset.id;

        if(btn.dataset.action==="delete") deleteProspect(id);
        if(btn.dataset.action==="edit"){
          const p = state.prospects.find(x=>x._id===id);
          if(!p) return;
          fillProspectForm(p);
          openModal("modalProspect");
        }
      });

      // Slot actions
      el.slots.addEventListener("click", (e)=>{
        const b = e.target.closest("button[data-slot-action]");
        if(!b) return;
        const action = b.dataset.slotAction;
        const hour = b.dataset.hour;
        const day = el.plannerDate.value || todayISO();

        if(action==="add"){
          resetSlotForm(hour);
          el.sDate.value = day;
          openModal("modalSlot");
        }
        if(action==="clear"){
          clearSlot(day, hour);
        }
      });

      // Close modals
      document.addEventListener("click", (e)=>{
        const c = e.target.closest("[data-close]");
        if(!c) return;
        closeModal(c.getAttribute("data-close"));
      });

      document.addEventListener("keydown", (e)=>{
        if(e.key!=="Escape") return;
        if(el.modalProspect.classList.contains("open")) closeModal("modalProspect");
        if(el.modalSlot.classList.contains("open")) closeModal("modalSlot");
        if(el.modalManual && el.modalManual.classList.contains("open")) closeModal("modalManual");
      });

      attachBackdropClose("modalProspect");
      attachBackdropClose("modalSlot");
      attachBackdropClose("modalManual");
    }

    /***********************
     * 13) Init
     ***********************/
    function populateSelects(){
      el.pUser.innerHTML = TEAM.map(u=>`<option value="${u}">${u}</option>`).join("");
      el.sUser.innerHTML = TEAM.map(u=>`<option value="${u}">${u}</option>`).join("");
      el.sHour.innerHTML = buildHours().map(h=>`<option value="${h}">${h}</option>`).join("");
      refreshSublineOptions();
    }

    function render(){
      if(state.view.type==="total"){
        el.pageTitle.textContent = "Tablero Total (Acumulado)";
        el.pageSub.innerHTML = 'Consolidado del equipo comercial. El cumplimiento de metas se calcula con base en registros en estado <b>Desembolsado</b>.';
        el.chartContext.textContent = "Contexto: equipo total";
      }else{
        el.pageTitle.textContent = `Planeador de ${state.view.user}`;
        el.pageSub.innerHTML = 'Gestión individual. El cumplimiento de metas se calcula con base en registros en estado <b>Desembolsado</b>.';
        el.chartContext.textContent = `Contexto: ${state.view.user}`;
      }

      // Active tab
      [...el.navTabs.querySelectorAll(".tab")].forEach(b=>{
        const isTotal = b.dataset.view==="total" && state.view.type==="total";
        const isUser  = b.dataset.view==="comercial" && state.view.type==="comercial" && b.dataset.user===state.view.user;
        b.classList.toggle("active", isTotal || isUser);
      });

      updateBadges();

      // rows in context + rowsAllContext for metas/charts (context without filters)
      let rowsAllContext = [...state.prospects];
      if(state.view.type==="comercial" && state.view.user){
        rowsAllContext = rowsAllContext.filter(r => r.user === state.view.user);
      }

      const rowsContext = viewRows();

      el.tbody.innerHTML = rowsContext.map(rowHTML).join("");

      // metas cards based on context (no filters)
      renderMetasCards(rowsAllContext);

      // KPIs and slots
      renderKPIs(rowsContext);
      renderSlots();
      renderQuick();

      // charts
      updateMetaCharts(rowsAllContext);
      updateCharts(rowsContext);

      // monthlyGoal (ind)
      const dateISO = el.plannerDate.value || todayISO();
      if(state.view.type==="comercial" && state.view.user){
        const g = getIndGoal(state.view.user, dateISO);
        el.monthlyGoal.value = g ? String(g) : "";
        el.monthlyGoal.disabled = false;
      }else{
        el.monthlyGoal.value = "";
        el.monthlyGoal.disabled = true;
      }
    }function applyVigenciaToUI(){
  const yl = document.getElementById("vigenciaLabel");
  if(yl) yl.textContent = String(VIGENCIA);
  document.querySelectorAll("[data-year-label]").forEach(n=> n.textContent = String(VIGENCIA));
  const cy = document.getElementById("copyrightYear");
  if(cy) cy.textContent = String(VIGENCIA);
  document.title = `INFIHUILA | Planeador Comercial + Metas ${VIGENCIA}`;
}

function ensureDefaultGoalsForYear(year){
  // Si aún no ha llegado Config desde Firestore, usa un default razonable
  if(year === 2026) GOALS = deepClone(DEFAULT_GOALS_2026);
  else GOALS = {
    colocacion:{ total:0, lines: { "Fomento":0, "Tesorería":0, "Cesión de derechos":0, "Libranza":0 } },
    captacion:{ total:0, lines: { "Depósitos a la Vista":0, "Depósitos a término fijo (CDAT)":0 } }
  };
}

function loadLocalStateForYear(year){
  setStorageKeys(year);
  state.prospects = safeGetJSON(STORAGE_KEY, []);
  state.goalsInd = safeGetJSON(STORAGE_GOALS_KEY, {});
  state.slots = safeGetJSON(STORAGE_SLOTS_KEY, {});
  state.view = { type:"total", user:null };

  // Mantén referencias para Firebase autosync
  window.__PLANEADOR__ = window.__PLANEADOR__ || {};
  window.__PLANEADOR__.STORAGE_KEY = STORAGE_KEY;
  window.__PLANEADOR__.STORAGE_GOALS_KEY = STORAGE_GOALS_KEY;
  window.__PLANEADOR__.STORAGE_SLOTS_KEY = STORAGE_SLOTS_KEY;
}

function populateVigenciaSelect(){
  const sel = document.getElementById("vigenciaSelect");
  if(!sel) return;
  const base = new Date().getFullYear();
  const years = [];
  for(let y=Math.min(2024, base-2); y<=Math.max(2035, base+3); y++) years.push(y);
  // Asegura que la vigencia actual esté
  if(!years.includes(VIGENCIA)) years.push(VIGENCIA);
  years.sort((a,b)=>a-b);
  sel.innerHTML = years.map(y=> `<option value="${y}">${y}</option>`).join("");
  sel.value = String(VIGENCIA);

  sel.addEventListener("change", ()=>{
    const y = Number(sel.value || "");
    if(!Number.isFinite(y) || y<2020 || y>2100) return;
    setVigencia(y);
  });
}

function setVigencia(year){
  if(year === VIGENCIA) return;
  VIGENCIA = year;
  localStorage.setItem("infihuila_planeador_vigencia", String(VIGENCIA));

  ensureDefaultGoalsForYear(VIGENCIA);
  loadLocalStateForYear(VIGENCIA);
  applyVigenciaToUI();

  // Notifica a Firebase (carga/guarda por vigencia)
  window.__PLANEADOR__ = window.__PLANEADOR__ || {};
  window.__PLANEADOR__.vigencia = VIGENCIA;
  (window.__PLANEADOR__._vigListeners || []).forEach(fn=>{
    try{ fn(VIGENCIA); } catch(e){}
  });

  // UI
  populateSelects();
  renderTabs();
  try{ render(); } catch(e){ console.warn(e); }
}



    function boot(){
  // Vigencia UI
  window.__PLANEADOR__ = window.__PLANEADOR__ || {};
  window.__PLANEADOR__.vigencia = VIGENCIA;

  applyVigenciaToUI();
  populateVigenciaSelect();

  // Inicializa selectores dependientes del equipo y pinta tabs
  populateSelects();
  renderTabs();

  initCharts();

  const tISO = todayISO();
  el.plannerDate.value = tISO;
  el.pDate.value = tISO;

  resetProspectForm();
  resetSlotForm();

  bindEvents();
  render();
}

    
    // --- Exponer referencias para el módulo Firebase (no rompe el diseño) ---
    window.__PLANEADOR__ = window.__PLANEADOR__ || {};
    window.__PLANEADOR__.state = state;          // estado (prospects, goalsInd, slots, view)
    window.__PLANEADOR__.render = render;        // rerender completo
    window.__PLANEADOR__.STORAGE_KEY = STORAGE_KEY;
    window.__PLANEADOR__.STORAGE_GOALS_KEY = STORAGE_GOALS_KEY;
    window.__PLANEADOR__.STORAGE_SLOTS_KEY = STORAGE_SLOTS_KEY;

// API para que Firebase/Admin cambien configuración sin romper UI
window.__PLANEADOR__.getVigencia = ()=> VIGENCIA;
window.__PLANEADOR__.setVigencia = (y)=> setVigencia(Number(y));
window.__PLANEADOR__.setTeam = (arr)=>{
  if(!Array.isArray(arr)) return;
  TEAM = arr.filter(Boolean).map(s=>String(s).trim()).filter(Boolean);
  if(TEAM.length===0) TEAM = deepClone(DEFAULT_TEAM);
  populateSelects();
  renderTabs();
  render();
};
window.__PLANEADOR__.setGoals = (g)=>{
  if(!g || typeof g!=="object") return;
  GOALS = g;
  render();
};
window.__PLANEADOR__._vigListeners = window.__PLANEADOR__._vigListeners || [];
window.__PLANEADOR__.onVigenciaChange = (fn)=>{
  if(typeof fn==="function") window.__PLANEADOR__._vigListeners.push(fn);
};

    document.addEventListener("DOMContentLoaded", boot);
  </script>

  
  <!-- Polyfill para evitar "process is not defined" (GitHub Pages / Browser) -->
  <script>
    (function(){
      if (typeof window.process === "undefined") window.process = { env: {} };
      if (typeof globalThis.process === "undefined") globalThis.process = window.process;
      if (typeof window.global === "undefined") window.global = window;
    })();
  </script>

  <!-- Firebase (Auth + Firestore + App Check) -->
  <script type="module">
  // ============================
  // Firebase (Auth + Firestore)
  // ============================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signOut,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  import {
    getFirestore,
    doc,
	    setDoc,
	    getDoc,
	    addDoc,
	    updateDoc,
	    deleteDoc,
	    collection,
	    getDocs,
	    query,
	    where,
	    orderBy,
	    limit,
	    collectionGroup,
	    FieldPath,
	    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyAPdpU73xMCD1ncg8DeNohVz4on3Uuu4EA",
      authDomain: "planeador-6ca40.firebaseapp.com",
      projectId: "planeador-6ca40",
      storageBucket: "planeador-6ca40.firebasestorage.app",
      messagingSenderId: "710007406557",
      appId: "1:710007406557:web:94951bd07376dd3d2e4034",
      measurementId: "G-43NGTHB2B6"
    };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // -----------------------------
  // Producción global (Tablero Total)
  // Lee los docs /Usuarios/*/State/{vigencia} usando collectionGroup.
  // Requiere reglas que permitan lectura autenticada.
  // -----------------------------
  async function loadGlobalState(vigencia) {
    const yearId = String(vigencia);
    const q = query(
      collectionGroup(db, 'State'),
      where(FieldPath.documentId(), '==', yearId)
    );
    const snap = await getDocs(q);
    const out = { vigencia: yearId, usuarios: {}, totales: {} };
    snap.forEach(d => {
      const data = d.data() || {};
      // Path esperado: Usuarios/{uid}/State/{year}
      const parts = d.ref.path.split('/');
      const uid = parts[1];
      out.usuarios[uid] = data;
      // Acumula campos numéricos comunes
      Object.keys(data).forEach(k => {
        const v = data[k];
        if (typeof v === 'number' && isFinite(v)) {
          out.totales[k] = (out.totales[k] || 0) + v;
        }
      });
    });
    return out;
  }

  // Exponer para el script principal (no-module) si lo requiere
  window.loadGlobalState = loadGlobalState;
// Defaults (idénticos a los del index principal)
  const DEFAULT_TEAM_SEED = (window.DEFAULT_TEAM && Array.isArray(window.DEFAULT_TEAM)) ? window.DEFAULT_TEAM : ["Alexander", "Luis Eduardo", "Carolina", "Natalia"];
  const DEFAULT_GOALS_2026_SEED = window.DEFAULT_GOALS ? window.DEFAULT_GOALS : {
  colocacion: {
    total: 34017113417,
    lines: { "Fomento": 16778075609, "Tesorería": 8389037808, "Cesión de derechos": 2850000000, "Libranza": 6000000000 }
  },
  captacion: {
    total: 40000000000,
    lines: { "Depósitos a la Vista": 30000000000, "Depósitos a término fijo (CDAT)": 10000000000 }
  }
  };


  // ----------------------------
  // UI helpers (bloqueo / desbloqueo)
  // ----------------------------
  const authGate = document.getElementById("authGate");
  const appShell = document.querySelector(".wrap"); // contenedor real del planeador
  const loginMsg = document.getElementById("loginMsg");
  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const btnLogin = document.getElementById("btnLogin");
  const btnReset = document.getElementById("btnReset");
  const btnLogout = document.getElementById("btnLogout");

  function lockApp(message = "Ingresa usuario y contraseña para acceder.") {
    if (authGate) authGate.style.display = "flex";
    if (appShell) appShell.style.display = "none";
    if (loginMsg) loginMsg.textContent = message || "";
  }

  function unlockApp() {
    if (authGate) authGate.style.display = "none";
    if (appShell) appShell.style.display = "";
    if (loginMsg) loginMsg.textContent = "";
  }

  lockApp();

  // ----------------------------
  // Auth actions
  // ----------------------------
  async function doLogin() {
    const email = (loginEmail?.value || "").trim();
    const pass = (loginPass?.value || "").trim();

    if (!email || !pass) {
      lockApp("Completa email y contraseña.");
      return;
    }

    btnLogin && (btnLogin.disabled = true);
    btnLogin && (btnLogin.style.opacity = "0.7");

    try {
      await signInWithEmailAndPassword(auth, email, pass);
      // el onAuthStateChanged se encargará del resto
    } catch (err) {
      console.error(err);
      const code = err?.code || "";
      let msg = "No fue posible iniciar sesión.";
      if (code.includes("auth/invalid-credential") || code.includes("auth/wrong-password")) msg = "Credenciales inválidas.";
      if (code.includes("auth/user-not-found")) msg = "Usuario no registrado.";
      if (code.includes("auth/too-many-requests")) msg = "Demasiados intentos. Intenta más tarde.";
      if (code.includes("auth/unauthorized-domain")) msg = "Dominio no autorizado en Firebase Auth (agrega casz56.github.io en Authentication > Settings > Authorized domains).";
      lockApp(msg);
    } finally {
      btnLogin && (btnLogin.disabled = false);
      btnLogin && (btnLogin.style.opacity = "1");
    }
  }

  btnLogin?.addEventListener("click", doLogin);
  btnLogout?.addEventListener("click", async () => {
    try {
      await signOut(auth);
    } catch (err) {
      console.error(err);
    } finally {
      lockApp();
    }
  });
  loginPass?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") doLogin();
  });

  btnReset?.addEventListener("click", async () => {
    const email = (loginEmail?.value || "").trim();
    if (!email) {
      lockApp("Escribe tu email para enviar el restablecimiento.");
      return;
    }
    try {
      await sendPasswordResetEmail(auth, email);
      lockApp("Listo: revisa tu correo para restablecer la contraseña.");
    } catch (err) {
      console.error(err);
      lockApp("No se pudo enviar el correo de restablecimiento.");
    }
  });

  // ----------------------------
  // Firestore helpers
  //   - Estado:  Usuarios/{uid}/State/main
  //   - Metas:   Usuarios/{uid}/Metas/2026
  // ----------------------------
  async function loadState(uid, year) {
  const ref = doc(db, "Usuarios", uid, "State", String(year));
  const snap = await getDoc(ref);
  return snap.exists() ? (snap.data() || null) : null;
}

async function saveState(uid, year, payload) {
  const ref = doc(db, "Usuarios", uid, "State", String(year));
  await setDoc(ref, { ...payload, updatedAt: serverTimestamp() }, { merge: true });
}


  // ----------------------------
// Config global (NO quemado en código)
//   - Equipo: Config/Equipo  { team:[...] }
//   - Metas institucionales por vigencia: MetasInstitucionales/{YYYY}
// ----------------------------
async function loadTeamConfig(){
  const ref = doc(db, "Config", "Equipo");
  const snap = await getDoc(ref);
  if(!snap.exists()) return null;
  const data = snap.data() || {};
  return Array.isArray(data.team) ? data.team : null;
}

async function loadGoalsConfig(year){
  const ref = doc(db, "MetasInstitucionales", String(year));
  const snap = await getDoc(ref);
  return snap.exists() ? (snap.data() || null) : null;
}

async function ensureConfigDefaults(year){
  // Asegura que exista el equipo (si no existe)
  const teamRef = doc(db, "Config", "Equipo");
  const teamSnap = await getDoc(teamRef);
  if(!teamSnap.exists()){
    await setDoc(teamRef, { team: DEFAULT_TEAM_SEED, updatedAt: serverTimestamp() }, { merge:true });
  }

  // Asegura metas para la vigencia (si no existe)
  const goalsRef = doc(db, "MetasInstitucionales", String(year));
  const goalsSnap = await getDoc(goalsRef);
  if(!goalsSnap.exists()){
    const seed = (Number(year) === 2026) ? DEFAULT_GOALS_2026_SEED : {
      colocacion:{ total:0, lines: { "Fomento":0, "Tesorería":0, "Cesión de derechos":0, "Libranza":0 } },
      captacion:{ total:0, lines: { "Depósitos a la Vista":0, "Depósitos a término fijo (CDAT)":0 } }
    };
    await setDoc(goalsRef, { ...seed, updatedAt: serverTimestamp() }, { merge:true });
  }
}


  // ----------------------------
  // Auto-sync: cuando cambie el localStorage, guarda en Firestore (si hay sesión)
  // ----------------------------
  let saveTimer = null;
  function scheduleSave(uid) {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      const p = window.__PLANEADOR__;
      if (!p?.state) return;

      const yearNow = window.__PLANEADOR__?.getVigencia?.() || window.__PLANEADOR__?.vigencia || new Date().getFullYear();
      const payload = {
        // Datos por usuario y por vigencia
        prospects: p.state.prospects ?? [],
        goalsInd: p.state.goalsInd ?? {},
        slots: p.state.slots ?? {},
        view: p.state.view ?? { type: "total", user: null },
        meta: {
          year: Number(yearNow),
          savedByUid: String(uid),
          savedByEmail: auth.currentUser?.email || null
        }
      };

      try {
        await saveState(uid, yearNow, payload);
      } catch (e) {
        console.warn("No se pudo guardar en Firestore:", e);
      }
    }, 700);
  }

  const originalSetItem = localStorage.setItem.bind(localStorage);
  localStorage.setItem = function(key, value) {
    originalSetItem(key, value);
    const u = auth.currentUser;
    const p = window.__PLANEADOR__;
    if (!u || !p) return;

    const keys = [p.STORAGE_KEY, p.STORAGE_GOALS_KEY, p.STORAGE_SLOTS_KEY];
    if (keys.includes(key)) scheduleSave(u.uid);
  };

  // ----------------------------
  // Sesión / control de acceso
  // ----------------------------
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      return lockApp("Ingresa usuario y contraseña para acceder.");
    }

    lockApp("Validando acceso…");

    try {
      const uref = doc(db, "Usuarios", user.uid);
      const usnap = await getDoc(uref);

      let udata = {};
      if (!usnap.exists()) {
        // Auto-provisión: crea el doc del usuario la primera vez que inicia sesión.
        // El admin luego puede ajustar rol / activar-desactivar desde admin.html
        udata = { isActive: true, role: "user" };
        await setDoc(uref, {
          email: user.email || null,
          role: "user",
          isActive: true,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      } else {
        udata = usnap.data() || {};
      }
      const isActive = udata.isActive !== false;

      if (!isActive) {
        await signOut(auth);
        return lockApp("Tu acceso está inactivo. Contacta al administrador.");
      }

      // Mantiene actualizado el doc del usuario
      await setDoc(uref, {
        email: user.email || null,
        updatedAt: serverTimestamp()
      }, { merge: true });

      
// Config global (equipo + metas por vigencia) + listener de vigencia
const p = window.__PLANEADOR__;
const year0 = p?.getVigencia?.() || p?.vigencia || new Date().getFullYear();

try { await ensureConfigDefaults(year0); } catch(e){ console.warn("No se pudo asegurar Config:", e); }

try {
  const team = await loadTeamConfig();
  if (team && p?.setTeam) p.setTeam(team);
} catch(e){ console.warn("No se pudo cargar Equipo:", e); }

try {
  const goals = await loadGoalsConfig(year0);
  if (goals && p?.setGoals) p.setGoals(goals);
} catch(e){ console.warn("No se pudo cargar Metas:", e); }

// Si el usuario cambia de vigencia en UI, recarga Estado + Metas de esa vigencia sin perder histórico
if (p?.onVigenciaChange) {
  p.onVigenciaChange(async (y)=>{
    try { await ensureConfigDefaults(y); } catch(e){}
    try {
      const goals = await loadGoalsConfig(y);
      if (goals && p?.setGoals) p.setGoals(goals);
    } catch(e){}
    try {
      const dataY = await loadState(user.uid, y);
      if (dataY && p?.state) {
        if (Array.isArray(dataY.prospects)) p.state.prospects = dataY.prospects;
        if (dataY.goalsInd && typeof dataY.goalsInd === "object") p.state.goalsInd = dataY.goalsInd;
        if (dataY.slots && typeof dataY.slots === "object") p.state.slots = dataY.slots;
        if (dataY.view && typeof dataY.view === "object") p.state.view = dataY.view;
        // Actualiza caché local para la vigencia seleccionada
        try {
          if (p.STORAGE_KEY) safeSetJSON(p.STORAGE_KEY, p.state.prospects);
          if (p.STORAGE_GOALS_KEY) safeSetJSON(p.STORAGE_GOALS_KEY, p.state.goalsInd);
          if (p.STORAGE_SLOTS_KEY) safeSetJSON(p.STORAGE_SLOTS_KEY, p.state.slots);
        } catch (e) {}
        try { p.render?.(); } catch(e){}
      } else {
        // Si no hay data en Firestore, deja lo local (ya lo cargó setVigencia)
        try { p.render?.(); } catch(e){}
      }
    } catch(e){ console.warn("No se pudo cargar estado de vigencia:", e); }
  });
}

      const year = window.__PLANEADOR__?.getVigencia?.() || window.__PLANEADOR__?.vigencia || new Date().getFullYear();
      const data = await loadState(user.uid, year);

      // Desbloquea UI (aunque Firestore no tenga nada todavía)
      unlockApp();

      // Si hay datos, aplícalos al planeador
      if (data) {
        const p = window.__PLANEADOR__;
        if (p?.state && p?.render) {
          if (Array.isArray(data.prospects)) p.state.prospects = data.prospects;
          if (data.goalsInd && typeof data.goalsInd === "object") p.state.goalsInd = data.goalsInd;
          if (data.slots && typeof data.slots === "object") p.state.slots = data.slots;
          if (data.view && typeof data.view === "object") p.state.view = data.view;

          // Sincroniza caché local para que la UI (y exportaciones) queden coherentes
          try {
            if (p.STORAGE_KEY) safeSetJSON(p.STORAGE_KEY, p.state.prospects);
            if (p.STORAGE_GOALS_KEY) safeSetJSON(p.STORAGE_GOALS_KEY, p.state.goalsInd);
            if (p.STORAGE_SLOTS_KEY) safeSetJSON(p.STORAGE_SLOTS_KEY, p.state.slots);
          } catch (e) {}

          try { p.render(); } catch (e) { console.warn("Render falló:", e); }
        }
      }
    } catch (err) {
      console.error(err);
      try { await signOut(auth); } catch {}
      lockApp("Error validando permisos. Intenta nuevamente.");
    }
  });
</script>


</body>
</html>