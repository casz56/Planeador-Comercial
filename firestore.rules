rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // Admin bootstrap opcional por correo (ajusta si deseas)
    function isBootstrapAdmin() {
      return signedIn() && request.auth.token.email == "admin@infihuila.gov.co";
    }

    function userDoc() {
      return get(/databases/$(database)/documents/Usuarios/$(request.auth.uid));
    }

    // Si el doc no existe aún, no bloquea lectura básica
    function isActiveUser() {
      return signedIn() && (
        !userDoc().exists() || userDoc().data.isActive == true || userDoc().data.isActive == null
      );
    }

    function isAdmin() {
      return isActiveUser() && userDoc().exists() && userDoc().data.role == "admin";
    }

    function canAdmin() {
      return isAdmin() || isBootstrapAdmin();
    }

    // Configuración general: cualquiera autenticado lee; solo admin escribe
    match /Config/{docId} {
      allow read: if signedIn();
      allow write: if canAdmin();
    }

    // Metas institucionales por vigencia: cualquiera autenticado lee; solo admin escribe
    match /MetasInstitucionales/{vigencia} {
      allow read: if signedIn();
      allow write: if canAdmin();
    }

    // Documento de usuario (perfil/rol)
    match /Usuarios/{uid} {
      // lectura: dueño o admin (no es necesario para leer State global)
      allow read: if signedIn() && (request.auth.uid == uid || canAdmin());

      // crear su propio doc
      allow create: if signedIn() && request.auth.uid == uid;

      // update: dueño sin cambiar role/isActive; admin puede todo
      allow update: if (
          signedIn() && request.auth.uid == uid
          && request.resource.data.role == resource.data.role
          && request.resource.data.isActive == resource.data.isActive
        ) || canAdmin();

      allow delete: if canAdmin();

      // ✅ PRODUCCIÓN (State)
      // Lectura GLOBAL: cualquier usuario logueado puede ver producción de todos
      // Escritura: solo dueño o admin
      match /State/{vigencia} {
        allow read: if signedIn(); 
        allow write: if (signedIn() && request.auth.uid == uid) || canAdmin();
      }
    }

    // default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
