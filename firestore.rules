rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isAdmin() { return signedIn() && (request.auth.token.admin == true || request.auth.token.role == "admin"); }

    // =========================
    // CONFIG / METAS (lectura general autenticada)
    // =========================
    match /Config/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /MetasInstitucionales/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // =========================
    // USUARIOS
    // NOTA: para poder ver "producción global" todos los usuarios autenticados
    // deben poder leer los perfiles (al menos para listar el equipo) y los State.
    // Escritura sigue protegida (solo dueño o admin).
    // =========================
    match /Usuarios/{uid} {
      // Lectura del documento del usuario (para listar equipo / roles / nombres)
      allow read: if signedIn();
      // Crear/actualizar: dueño o admin
      allow create: if signedIn() && request.auth.uid == uid;
      allow update, delete: if isAdmin() || (signedIn() && request.auth.uid == uid);

      // Estados por vigencia (producción / metas cargadas por usuario)
      match /State/{vigencia} {
        // *** CLAVE PARA PRODUCCIÓN GLOBAL ***
        // Cualquier usuario autenticado puede LEER los estados para sumar el tablero global.
        allow read: if signedIn();

        // Solo dueño o admin puede escribir
        allow create, update, delete: if isAdmin() || (signedIn() && request.auth.uid == uid);
      }

      // Bloqueo de subcolecciones no contempladas
      match /{document=**} {
        allow read, write: if false;
      }
    }

    // Denegar todo lo no contemplado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
