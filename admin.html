<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INFIHUILA | Admin de Accesos</title>

  <style>
    :root{
      --teal:#0b6f73; --teal2:#0a5b5e; --teal3:#084a52;
      --lime:#ccd400; --olive:#5c6b3f;
      --bg:#f4f7f9; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e6edf3;
      --shadow:0 18px 50px rgba(2,6,23,.10); --shadow2:0 10px 30px rgba(2,6,23,.08);
      --r:18px; --r2:26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at 10% 0%, rgba(204,212,0,.13), transparent 60%),
        radial-gradient(1000px 520px at 90% 0%, rgba(11,111,115,.16), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 18px 90px}
    .header{
      border-radius: 34px; padding: 18px 22px; color:#fff;
      background: linear-gradient(135deg, rgba(11,111,115,1) 0%, rgba(10,91,94,1) 55%, rgba(13,99,60,1) 100%);
      box-shadow: var(--shadow); position:relative; overflow:hidden;
    }
    .header::after{
      content:""; position:absolute; inset:-80px -160px auto auto;
      width: 580px; height: 260px; transform: rotate(-12deg);
      background: radial-gradient(circle at 30% 40%, rgba(204,212,0,.50), transparent 64%);
      opacity:.55; pointer-events:none;
    }
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;position:relative;z-index:1}
    .brand{display:flex;align-items:center;gap:14px;min-width:280px}
    .title h1{margin:0;font-size:18px;font-weight:1000;line-height:1.15}
    .title p{margin:4px 0 0;font-size:13px;opacity:.9}
    .chip{
      display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);white-space:nowrap;font-weight:900;font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--lime);box-shadow:0 0 0 5px rgba(204,212,0,.14)}
    .row{margin-top:14px;display:grid;grid-template-columns: 1fr;gap:14px}
    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:14px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);box-shadow:var(--shadow2);overflow:hidden}
    .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(180deg, rgba(11,111,115,.05), transparent)}
    .hd h3{margin:0;font-size:14px;font-weight:1000;color:var(--teal3)}
    .bd{padding:14px 16px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:160px;flex:1}
    label{font-size:12px;color:var(--muted);font-weight:900}
    input,select{
      width:100%;border:1px solid var(--border);border-radius:16px;padding:10px;outline:none;background:#fff;font:inherit;font-size:13px;
    }
    .btn{
      border:1px solid rgba(11,111,115,.15);background:rgba(255,255,255,.88);
      color:var(--teal2);font-weight:1000;padding:10px 12px;border-radius:16px;cursor:pointer;box-shadow:var(--shadow2);
    }
    .btn:hover{background:#fff}
    .btn.primary{
      border:0;color:#fff;background:linear-gradient(135deg, var(--teal) 0%, var(--teal2) 70%);
      box-shadow:0 18px 40px rgba(11,111,115,.20);
    }
    .btn.danger{border-color:rgba(239,68,68,.25);color:#7f1d1d}
    .btn.danger:hover{background:rgba(239,68,68,.07)}
    .muted{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .table-wrap{overflow:auto;border-radius:18px;border:1px solid var(--border);background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
    thead th{position:sticky;top:0;background:#f8fafc;font-size:12px;text-align:left;padding:10px;border-bottom:1px solid var(--border);white-space:nowrap}
    tbody td{font-size:12px;padding:10px;border-bottom:1px solid #f0f4f8;vertical-align:top}
    tbody tr:hover{background:rgba(11,111,115,.04)}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-weight:1000;font-size:11px;border:1px solid transparent;white-space:nowrap}
    .ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.28);color:#14532d}
    .no{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.22);color:#7f1d1d}
    .admin{background:rgba(204,212,0,.22);border-color:rgba(204,212,0,.40);color:#3b3b00}
    .user{background:rgba(100,116,139,.14);border-color:rgba(100,116,139,.22);color:#334155}
    .footer{
      position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.92);backdrop-filter: blur(10px);
      border-top:1px solid var(--border);padding:10px 14px;font-size:12px;color:var(--muted);text-align:center;z-index:10;
    }
    .hidden{display:none !important}
    .msg{font-size:12px;margin-top:8px}
  </style>

  <!-- Polyfill para GitHub Pages -->
  <script>
    (function(){
      if (typeof window.process === "undefined") window.process = { env: {} };
      if (typeof globalThis.process === "undefined") globalThis.process = window.process;
      if (typeof window.global === "undefined") window.global = window;
    })();
  </script>
</head>

<body>
  <div class="wrap">
    <header class="header">
      <div class="header-row">
        <div class="brand">
          <div class="title">
            <h1>Admin de Accesos · Planeador Comercial</h1>
            <p>Gestión de usuarios, roles y habilitación de acceso (Firebase Auth + Firestore)</p>
          </div>
        </div>
        <div class="chip"><span class="dot"></span><span id="sessionChip">Sin sesión</span></div>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="loginCard" class="row">
      <div class="card">
        <div class="hd"><h3>Iniciar sesión (solo admins)</h3></div>
        <div class="bd">
          <div class="toolbar">
            <div class="field">
              <label>Email</label>
              <input id="email" type="email" placeholder="admin@infihuila.gov.co" />
            </div>
            <div class="field">
              <label>Contraseña</label>
              <input id="pass" type="password" placeholder="••••••••" />
            </div>
            <button class="btn primary" id="btnLogin">Entrar</button>
            <button class="btn" id="btnReset">Enviar reset</button>
          </div>
          <div id="loginMsg" class="msg muted"></div>
          <div class="msg muted">
            Nota: el permiso se valida por <b>Usuarios/{uid}.role == "admin"</b>.
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="adminPanel" class="row hidden">
      <div class="grid2">
        <!-- Crear usuario -->
        <div class="card">
          <div class="hd"><h3>Crear usuario (Auth + Firestore)</h3></div>
          <div class="bd">
            <div class="toolbar">
              <div class="field">
                <label>Email (nuevo)</label>
                <input id="newEmail" type="email" placeholder="usuario@dominio.com" />
              </div>
              <div class="field">
                <label>Contraseña (temporal)</label>
                <input id="newPass" type="password" placeholder="Mín. 6 caracteres" />
              </div>
              <div class="field">
                <label>Rol</label>
                <select id="newRole">
                  <option value="user">user</option>
                  <option value="admin">admin</option>
                </select>
              </div>
              <div class="field">
                <label>Activo</label>
                <select id="newActive">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <button class="btn primary" id="btnCreate">Crear</button>
            </div>
            <div id="createMsg" class="msg muted"></div>
            <div class="msg muted">
              Se crea en <b>Firebase Auth</b> y se registra en <b>Firestore</b> como <code>Usuarios/{uid}</code>.
            </div>
          </div>
        </div>

        <!-- Sesión / acciones -->
        <div class="card">
          <div class="hd"><h3>Sesión y accesos</h3></div>
          <div class="bd">
            <div class="toolbar">
              <button class="btn" id="btnGoPlaneador">Abrir Planeador</button>
              <button class="btn danger" id="btnLogout">Cerrar sesión</button>
            </div>
            <div class="msg muted">
              Recomendación: Mantén <b>isActive</b> en false para cuentas de prueba hasta que estén listas.
            </div>
            <div id="panelMsg" class="msg muted"></div>
          </div>
        </div>
      </div>

      <!-- Tabla usuarios -->
      <div class="card">
        <div class="hd">
          <h3>Usuarios registrados (Firestore: Usuarios)</h3>
          <div class="toolbar">
            <div class="field" style="min-width:240px">
              <label>Buscar</label>
              <input id="q" placeholder="filtrar por email / uid" />
            </div>
            <button class="btn" id="btnRefresh">Refrescar</button>
          </div>
        </div>
        <div class="bd">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>UID</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Activo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          <div class="msg muted">
            Tip: puedes cambiar rol/activo y queda guardado en Firestore inmediatamente.
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">© 2026 INFIHUILA - Instituto de Financiamiento, Promoción y Desarrollo del Huila · Documento controlado.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      query,
      limit,
      serverTimestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ Usa el mismo firebaseConfig de tu index.html :contentReference[oaicite:1]{index=1}
    const firebaseConfig = {
      apiKey: "AIzaSyAPdpU73xMCD1ncg8DeNohVz4on3Uuu4EA",
      authDomain: "planeador-6ca40.firebaseapp.com",
      projectId: "planeador-6ca40",
      storageBucket: "planeador-6ca40.firebasestorage.app",
      messagingSenderId: "710007406557",
      appId: "1:710007406557:web:94951bd07376dd3d2e4034",
      measurementId: "G-43NGTHB2B6"
    };

    // App principal (sesión del admin)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // App secundario (crear usuarios SIN cerrar sesión del admin)
    const app2 = initializeApp(firebaseConfig, "secondary");
    const auth2 = getAuth(app2);

    const $ = (id)=>document.getElementById(id);

    const loginCard = $("loginCard");
    const adminPanel = $("adminPanel");
    const sessionChip = $("sessionChip");

    const loginMsg = $("loginMsg");
    const createMsg = $("createMsg");
    const panelMsg = $("panelMsg");
    const tbody = $("tbody");

    let cachedUsers = [];

    function pillRole(role){
      return role === "admin"
        ? `<span class="pill admin">admin</span>`
        : `<span class="pill user">user</span>`;
    }
    function pillActive(active){
      return active
        ? `<span class="pill ok">true</span>`
        : `<span class="pill no">false</span>`;
    }

    async function isAdmin(uid){
      const ref = doc(db, "Usuarios", uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : null;
      return !!(data && data.role === "admin" && data.isActive !== false);
    }

    async function ensureAdminDoc(user){
      const ref = doc(db, "Usuarios", user.uid);
      await setDoc(ref, {
        email: user.email || null,
        role: "admin",
        isActive: true,
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    function showLoggedOut(){
      loginCard.classList.remove("hidden");
      adminPanel.classList.add("hidden");
      sessionChip.textContent = "Sin sesión";
    }
    function showLoggedIn(user){
      loginCard.classList.add("hidden");
      adminPanel.classList.remove("hidden");
      sessionChip.textContent = user?.email ? `Admin: ${user.email}` : `Admin: ${user.uid}`;
    }

    async function loadUsers(){
      panelMsg.textContent = "Cargando usuarios…";
      const qref = query(collection(db, "Usuarios"), limit(500));
      const snap = await getDocs(qref);
      cachedUsers = snap.docs.map(d=>({ uid:d.id, ...(d.data()||{}) }));
      panelMsg.textContent = `Usuarios cargados: ${cachedUsers.length}`;
      renderUsers();
    }

    function renderUsers(){
      const term = ($("q").value || "").trim().toLowerCase();
      const rows = cachedUsers
        .filter(u => !term || (u.uid||"").toLowerCase().includes(term) || (u.email||"").toLowerCase().includes(term))
        .sort((a,b)=> String(a.email||"").localeCompare(String(b.email||"")));

      tbody.innerHTML = rows.map(u=>{
        const role = u.role || "user";
        const active = u.isActive !== false;

        return `
          <tr>
            <td><code>${u.uid}</code></td>
            <td>${u.email || "<span class='muted'>—</span>"}</td>
            <td>
              ${pillRole(role)}
              <div class="muted" style="margin-top:6px">
                <select data-action="setRole" data-uid="${u.uid}">
                  <option value="user" ${role==="user"?"selected":""}>user</option>
                  <option value="admin" ${role==="admin"?"selected":""}>admin</option>
                </select>
              </div>
            </td>
            <td>
              ${pillActive(active)}
              <div class="muted" style="margin-top:6px">
                <select data-action="setActive" data-uid="${u.uid}">
                  <option value="true" ${active?"selected":""}>true</option>
                  <option value="false" ${!active?"selected":""}>false</option>
                </select>
              </div>
            </td>
            <td>
              <button class="btn" data-action="resetPwd" data-email="${u.email||""}">Reset clave</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    tbody.addEventListener("change", async (e)=>{
      const sel = e.target.closest("select");
      if(!sel) return;
      const action = sel.dataset.action;
      const uid = sel.dataset.uid;
      if(!action || !uid) return;

      try{
        const ref = doc(db, "Usuarios", uid);
        if(action === "setRole"){
          await updateDoc(ref, { role: sel.value, updatedAt: serverTimestamp() });
        }else if(action === "setActive"){
          await updateDoc(ref, { isActive: (sel.value === "true"), updatedAt: serverTimestamp() });
        }
        // refresca cache local
        const idx = cachedUsers.findIndex(x=>x.uid===uid);
        if(idx>=0){
          if(action==="setRole") cachedUsers[idx].role = sel.value;
          if(action==="setActive") cachedUsers[idx].isActive = (sel.value==="true");
        }
        renderUsers();
      }catch(err){
        alert("No se pudo guardar el cambio. Revisa permisos/reglas.");
        console.error(err);
      }
    });

    tbody.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const action = btn.dataset.action;

      if(action === "resetPwd"){
        const email = btn.dataset.email;
        if(!email){ alert("Este usuario no tiene email registrado."); return; }
        try{
          await sendPasswordResetEmail(auth, email);
          alert("Correo de restablecimiento enviado.");
        }catch(err){
          alert("No se pudo enviar reset. Revisa Auth / dominio autorizado.");
          console.error(err);
        }
      }
    });

    $("q").addEventListener("input", renderUsers);

    $("btnRefresh").onclick = loadUsers;

    $("btnGoPlaneador").onclick = ()=>{ window.location.href = "./index.html"; };

    $("btnLogout").onclick = async ()=>{ await signOut(auth); };

    $("btnLogin").onclick = async ()=>{
      loginMsg.textContent = "";
      try{
        const email = $("email").value.trim();
        const pass = $("pass").value;
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        console.error(err);
        loginMsg.textContent = err?.message || "No se pudo iniciar sesión.";
      }
    };

    $("btnReset").onclick = async ()=>{
      loginMsg.textContent = "";
      try{
        const email = $("email").value.trim();
        if(!email) { loginMsg.textContent = "Ingresa el email para enviar reset."; return; }
        await sendPasswordResetEmail(auth, email);
        loginMsg.textContent = "Listo: se envió el correo de restablecimiento.";
      }catch(err){
        console.error(err);
        loginMsg.textContent = err?.message || "No se pudo enviar reset.";
      }
    };

    $("btnCreate").onclick = async ()=>{
      createMsg.textContent = "";
      const email = $("newEmail").value.trim();
      const pass = $("newPass").value;
      const role = $("newRole").value;
      const isActive = $("newActive").value === "true";

      if(!email){ createMsg.textContent = "Email requerido."; return; }
      if(!pass || pass.length < 6){ createMsg.textContent = "Contraseña mínimo 6 caracteres."; return; }

      try{
        // Crear usuario en Auth usando app secundario
        const cred = await (await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"))
          .createUserWithEmailAndPassword(auth2, email, pass);

        const newUid = cred.user.uid;

        // Crear/merge doc en Firestore
        await setDoc(doc(db, "Usuarios", newUid), {
          email,
          role,
          isActive,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        // cerrar sesión del auth2 para no “ensuciar”
        await signOut(auth2);

        createMsg.textContent = `Usuario creado: ${email} (${role}, isActive=${isActive})`;
        $("newEmail").value = "";
        $("newPass").value = "";
        await loadUsers();
      }catch(err){
        console.error(err);
        createMsg.textContent = err?.message || "No se pudo crear el usuario.";
      }
    };

    // Gate principal: solo admins (role=admin y activo)
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showLoggedOut(); return; }

      try{
        // (Opcional) si estás entrando por primera vez con tu cuenta admin y aún no existe doc:
        const ref = doc(db, "Usuarios", user.uid);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          await ensureAdminDoc(user);
        }

        const ok = await isAdmin(user.uid);
        if(!ok){
          await signOut(auth);
          showLoggedOut();
          loginMsg.textContent = "Acceso denegado: tu usuario no es admin o está inactivo.";
          return;
        }

        showLoggedIn(user);
        await loadUsers();
      }catch(err){
        console.error(err);
        await signOut(auth);
        showLoggedOut();
        loginMsg.textContent = "Error validando permisos. Revisa reglas de Firestore.";
      }
    });
  </script>
</body>
</html>
